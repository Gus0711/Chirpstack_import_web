<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChirpStack Device Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-input: #1a1a25;
            --accent: #00d4aa;
            --accent-dim: #00d4aa33;
            --text: #e8e8ef;
            --text-dim: #6b6b80;
            --border: #2a2a3a;
            --error: #ff5c5c;
            --success: #00d4aa;
            --warning: #ffb84d;
            --step-inactive: #3a3a4a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Selection color */
        ::selection {
            background: var(--accent);
            color: var(--bg-dark);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            position: relative;
        }

        /* Subtle gradient overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at top, rgba(0, 212, 170, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* LoRa Signal Animation Container */
        .lora-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: -2;
            overflow: hidden;
            opacity: 0.4;
        }

        /* Device icon */
        .lora-device {
            position: absolute;
            bottom: 15%;
            left: 8%;
            width: 24px;
            height: 24px;
            background: var(--accent);
            border-radius: 4px;
            opacity: 0.6;
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.4);
        }

        .lora-device::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--bg-dark);
            border-radius: 2px;
        }

        /* Gateway icon */
        .lora-gateway {
            position: absolute;
            top: 20%;
            right: 10%;
            width: 40px;
            height: 50px;
            opacity: 0.6;
        }

        .lora-gateway::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 25px;
            background: var(--accent);
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.4);
        }

        .lora-gateway::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 25px;
            background: var(--accent);
            border-radius: 2px;
        }

        /* Signal waves from device */
        .signal-wave {
            position: absolute;
            bottom: 15%;
            left: 8%;
            width: 24px;
            height: 24px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            opacity: 0;
            animation: wave-expand 4s ease-out infinite;
        }

        .signal-wave:nth-child(2) { animation-delay: 1s; }
        .signal-wave:nth-child(3) { animation-delay: 2s; }
        .signal-wave:nth-child(4) { animation-delay: 3s; }

        @keyframes wave-expand {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(25);
                opacity: 0;
            }
        }

        /* Traveling signal dot */
        .signal-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
            opacity: 0;
            animation: travel-signal 4s ease-in-out infinite;
        }

        .signal-dot:nth-child(6) { animation-delay: 1.5s; }
        .signal-dot:nth-child(7) { animation-delay: 3s; }

        @keyframes travel-signal {
            0% {
                bottom: 15%;
                left: 10%;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                bottom: 75%;
                left: 88%;
                opacity: 0;
            }
        }

        /* Second device - bottom right */
        .lora-device-2 {
            position: absolute;
            bottom: 25%;
            right: 25%;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 4px;
            opacity: 0.4;
            box-shadow: 0 0 15px rgba(0, 212, 170, 0.3);
        }

        .lora-device-2::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: var(--bg-dark);
            border-radius: 2px;
        }

        /* Signal waves from device 2 */
        .signal-wave-2 {
            position: absolute;
            bottom: 25%;
            right: 25%;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            opacity: 0;
            animation: wave-expand-2 5s ease-out infinite;
        }

        .signal-wave-2:nth-child(9) { animation-delay: 1.25s; }
        .signal-wave-2:nth-child(10) { animation-delay: 2.5s; }
        .signal-wave-2:nth-child(11) { animation-delay: 3.75s; }

        @keyframes wave-expand-2 {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            100% {
                transform: scale(15);
                opacity: 0;
            }
        }

        /* Traveling signal from device 2 */
        .signal-dot-2 {
            position: absolute;
            width: 5px;
            height: 5px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--accent);
            opacity: 0;
            animation: travel-signal-2 5s ease-in-out infinite;
        }

        .signal-dot-2:nth-child(13) { animation-delay: 2s; }

        @keyframes travel-signal-2 {
            0% {
                bottom: 26%;
                right: 26%;
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                top: 22%;
                right: 11%;
                bottom: auto;
                opacity: 0;
            }
        }

        /* Receiving pulse on gateway */
        .gateway-pulse {
            position: absolute;
            top: 20%;
            right: 10%;
            width: 40px;
            height: 50px;
            border: 2px solid var(--accent);
            border-radius: 8px;
            opacity: 0;
            animation: gateway-receive 4s ease-out infinite;
        }

        .gateway-pulse:nth-child(15) { animation-delay: 1.5s; }

        @keyframes gateway-receive {
            0%, 90% {
                transform: scale(1);
                opacity: 0;
            }
            95% {
                transform: scale(1.2);
                opacity: 0.6;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            animation: fadeIn 0.4s ease-out;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .status-dot.success {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .status-dot.error {
            background: var(--error);
            box-shadow: 0 0 10px var(--error);
        }

        .status-dot.pending {
            background: var(--warning);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border);
            position: relative;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #00ffcc, var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: gradient-shift 3s ease infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        header p {
            color: var(--text-dim);
            font-weight: 300;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out both;
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card:hover {
            border-color: rgba(0, 212, 170, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 212, 170, 0.1);
            transform: translateY(-2px);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 10px var(--accent-dim);
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 0.4rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        label:hover {
            color: var(--text);
        }

        input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        input:hover, select:hover {
            border-color: rgba(0, 212, 170, 0.3);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim), 0 0 20px rgba(0, 212, 170, 0.1);
            background: rgba(26, 26, 37, 0.8);
        }

        input::placeholder {
            color: var(--text-dim);
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, var(--accent-dim) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            pointer-events: none;
        }

        .drop-zone:hover::before, .drop-zone.dragover::before {
            width: 300%;
            height: 300%;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(0, 212, 170, 0.15);
        }

        .drop-zone svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            color: var(--text-dim);
        }

        .drop-zone p {
            color: var(--text-dim);
            font-size: 0.95rem;
        }

        .drop-zone .filename {
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .mapping-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mapping-item label {
            min-width: 100px;
            margin-bottom: 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .mapping-item select {
            margin-bottom: 0;
            flex: 1;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tag {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--bg-input), rgba(0, 212, 170, 0.05));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.4rem 0.85rem;
            font-size: 0.85rem;
            transition: all 0.2s;
            animation: tag-pop 0.3s ease;
        }

        @keyframes tag-pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .tag:hover {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(0, 212, 170, 0.2);
            transform: translateY(-1px);
        }

        .tag-key {
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .tag-value {
            color: var(--text-dim);
        }

        .tag button {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.1rem 0.3rem;
            font-size: 0.9rem;
            line-height: 1;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .tag button:hover {
            color: var(--error);
            background: rgba(255, 92, 92, 0.15);
        }

        .add-tag {
            display: flex;
            gap: 0.5rem;
        }

        .add-tag input {
            flex: 1;
            margin-bottom: 0;
        }

        button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #00e6b8);
            color: var(--bg-dark);
            border: none;
            box-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 212, 170, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary:disabled::before {
            display: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 212, 170, 0.1);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .preview-section {
            margin-top: 2rem;
            animation: fadeInUp 0.4s ease-out;
        }

        .preview-table {
            width: 100%;
            overflow-x: auto;
            margin-top: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th, td {
            padding: 0.85rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            position: relative;
        }

        th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }

        th {
            background: var(--bg-input);
            font-weight: 600;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-dim);
            transition: all 0.2s;
        }

        tr {
            transition: all 0.2s;
        }

        tr:hover {
            background: rgba(0, 212, 170, 0.05);
        }

        tr:hover td {
            color: var(--text);
            border-color: rgba(0, 212, 170, 0.2);
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .log-container {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            margin-top: 1rem;
            border: 1px solid var(--border);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .log-entry {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid var(--border);
            border-radius: 4px;
            transition: background 0.2s;
        }

        .log-entry:hover {
            background: rgba(0, 212, 170, 0.05);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-success { color: var(--success); text-shadow: 0 0 10px rgba(0, 212, 170, 0.3); }
        .log-error { color: var(--error); text-shadow: 0 0 10px rgba(255, 92, 92, 0.3); }
        .log-info { color: var(--text-dim); }

        .stats {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .stat {
            text-align: center;
            padding: 1rem 1.5rem;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat:hover {
            transform: scale(1.05);
            border-color: rgba(0, 212, 170, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .stat-success .stat-value { color: var(--success); text-shadow: 0 0 20px rgba(0, 212, 170, 0.4); }
        .stat-error .stat-value { color: var(--error); text-shadow: 0 0 20px rgba(255, 92, 92, 0.4); }
        .stat-total .stat-value { color: var(--accent); text-shadow: 0 0 20px rgba(0, 212, 170, 0.4); }

        .hidden { display: none !important; }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-bottom: 0;
        }

        .separator-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .separator-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .separator-options input[type="radio"] {
            width: auto;
            margin-bottom: 0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Stepper */
        .stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 3rem;
            gap: 0;
            animation: fadeIn 0.6s ease-out 0.3s both;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .step:hover {
            transform: scale(1.05);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--step-inactive);
            color: var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.4s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .step.active .step-number {
            background: var(--accent);
            color: var(--bg-dark);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.5), 0 0 40px rgba(0, 212, 170, 0.2);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 212, 170, 0.5), 0 0 40px rgba(0, 212, 170, 0.2); }
            50% { box-shadow: 0 0 25px rgba(0, 212, 170, 0.7), 0 0 50px rgba(0, 212, 170, 0.3); }
        }

        .step.completed .step-number {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .step.completed .step-number::after {
            content: 'âœ“';
            position: absolute;
            font-size: 1rem;
        }

        .step-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-weight: 500;
            transition: all 0.3s;
        }

        .step.active .step-label {
            color: var(--accent);
            text-shadow: 0 0 10px rgba(0, 212, 170, 0.3);
        }

        .step.completed .step-label {
            color: var(--text);
        }

        .step-connector {
            width: 60px;
            height: 2px;
            background: var(--step-inactive);
            margin: 0 1rem;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .step-connector.completed {
            background: var(--accent);
            box-shadow: 0 0 10px rgba(0, 212, 170, 0.3);
        }

        .step-connector.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: connector-shine 1.5s ease-out;
        }

        @keyframes connector-shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @media (max-width: 700px) {
            .stepper {
                flex-wrap: wrap;
                gap: 1rem;
            }
            .step-connector {
                display: none;
            }
            .step-label {
                display: none;
            }
        }

        /* Step content */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        /* Connection status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .connection-status.success {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .connection-status.error {
            background: rgba(255, 92, 92, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .connection-status.loading {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-dim);
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Select styling */
        .select-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .select-wrapper select {
            appearance: none;
            padding-right: 2.5rem;
        }

        .select-wrapper::after {
            content: '';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--text-dim);
            pointer-events: none;
        }

        .info-box {
            background: var(--bg-input);
            border-left: 3px solid var(--accent);
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .info-box code {
            background: var(--bg-dark);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
        }

        .card-centered {
            max-width: 500px;
            margin: 0 auto;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: modal-fade-in 0.3s ease;
        }

        @keyframes modal-fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(0, 212, 170, 0.1);
            animation: modal-slide-up 0.3s ease;
        }

        @keyframes modal-slide-up {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            background: linear-gradient(135deg, var(--accent), #00ffcc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            line-height: 1;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--error);
            background: rgba(255, 92, 92, 0.1);
        }

        .profile-list {
            margin-bottom: 1.5rem;
        }

        .profile-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .profile-item:hover {
            border-color: rgba(0, 212, 170, 0.3);
            transform: translateX(4px);
        }

        .profile-item-info {
            flex: 1;
        }

        .profile-item-name {
            font-weight: 600;
            color: var(--text);
        }

        .profile-item-tags {
            font-size: 0.8rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        .profile-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .profile-item-actions button {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            font-size: 1rem;
        }

        .profile-item-actions button:hover {
            color: var(--accent);
        }

        .profile-item-actions button.delete:hover {
            color: var(--error);
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 42px;
            margin-bottom: 1rem;
        }

        .tag-chip {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .tag-chip button {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
        }

        .tag-chip button:hover {
            color: var(--error);
        }

        .tag-input {
            flex: 1;
            min-width: 100px;
            border: none;
            background: transparent;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            outline: none;
            padding: 0.25rem;
        }

        /* Profile selector in step 3 */
        .profile-selector {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .profile-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .profile-selector-header label {
            margin-bottom: 0;
        }

        .btn-icon {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .btn-icon:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Tenant Dashboard */
        .tenant-dashboard {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.05), rgba(0, 212, 170, 0.02));
            border: 1px solid var(--border);
            border-radius: 12px;
            animation: fadeInUp 0.4s ease-out;
        }

        .tenant-dashboard.loading {
            opacity: 0.6;
        }

        .tenant-dashboard h4 {
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tenant-dashboard h4 svg {
            width: 18px;
            height: 18px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .dashboard-stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .dashboard-stat:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .dashboard-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
        }

        .dashboard-stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dashboard-stat.active .dashboard-stat-value {
            color: var(--success);
            text-shadow: 0 0 15px rgba(0, 212, 170, 0.4);
        }

        .dashboard-stat.inactive .dashboard-stat-value {
            color: var(--warning);
        }

        .dashboard-stat.never .dashboard-stat-value {
            color: var(--text-dim);
        }

        .dashboard-stat.gateway .dashboard-stat-value {
            color: var(--accent);
            text-shadow: 0 0 15px rgba(0, 212, 170, 0.4);
        }

        .dashboard-stat.error .dashboard-stat-value {
            color: var(--error);
        }

        /* Server Selector */
        .server-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .server-input-wrapper {
            flex: 1;
            position: relative;
        }

        .server-input-wrapper input {
            padding-right: 2.5rem;
        }

        .server-select-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-70%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .server-select-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .server-select-btn svg {
            width: 14px;
            height: 14px;
        }

        .save-server-btn {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 38px;
            height: 38px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            flex-shrink: 0;
            margin-top: 1.5rem;
        }

        .save-server-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(0, 212, 170, 0.1);
        }

        .save-server-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Server dropdown */
        .server-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            max-height: 250px;
            overflow-y: auto;
            animation: dropdown-show 0.2s ease;
        }

        @keyframes dropdown-show {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .server-dropdown.hidden {
            display: none;
        }

        .server-dropdown-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .server-dropdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .server-dropdown-item:last-child {
            border-bottom: none;
        }

        .server-dropdown-item:hover {
            background: rgba(0, 212, 170, 0.1);
        }

        .server-dropdown-item-info {
            flex: 1;
            min-width: 0;
        }

        .server-dropdown-item-name {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.2rem;
        }

        .server-dropdown-item-url {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .server-dropdown-item-delete {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
            margin-left: 0.5rem;
            opacity: 0;
        }

        .server-dropdown-item:hover .server-dropdown-item-delete {
            opacity: 1;
        }

        .server-dropdown-item-delete:hover {
            color: var(--error);
            background: rgba(255, 92, 92, 0.1);
        }

        .server-dropdown-empty {
            padding: 1.5rem 1rem;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        /* Save server modal */
        .save-server-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            z-index: 1001;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modal-slide-up 0.3s ease;
        }

        .save-server-modal.hidden {
            display: none;
        }

        .save-server-modal h3 {
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .save-server-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .save-server-modal-backdrop.hidden {
            display: none;
        }

        /* Import Mode Toggle */
        .import-mode-toggle {
            display: flex;
            background: var(--bg-input);
            border-radius: 10px;
            padding: 4px;
            margin: 1.5rem 0;
            border: 1px solid var(--border);
        }

        .import-mode-toggle.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .mode-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .mode-btn:hover {
            color: var(--text);
        }

        .mode-btn.active {
            background: var(--accent);
            color: var(--bg-dark);
            box-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
        }

        .mode-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Manual Entry Form */
        .manual-entry-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .manual-device-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
            animation: fadeInUp 0.3s ease-out;
        }

        .manual-device-card:hover {
            border-color: rgba(0, 212, 170, 0.3);
        }

        .manual-device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .manual-device-header h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .manual-device-header h4 span {
            background: var(--accent);
            color: var(--bg-dark);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .remove-device-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .remove-device-btn:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(255, 92, 92, 0.1);
        }

        .manual-device-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .manual-device-fields .field-full {
            grid-column: 1 / -1;
        }

        .manual-device-fields label {
            margin-bottom: 0.3rem;
        }

        .manual-device-fields input {
            margin-bottom: 0;
        }

        .manual-device-tags {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border);
        }

        .manual-device-tags h5 {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .manual-tags-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .manual-tag-field label {
            font-size: 0.8rem;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .manual-tag-field input {
            margin-bottom: 0;
            font-size: 0.85rem;
        }

        /* Add device button */
        .add-device-btn {
            width: 100%;
            padding: 1rem;
            border: 2px dashed var(--border);
            border-radius: 12px;
            background: transparent;
            color: var(--text-dim);
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .add-device-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(0, 212, 170, 0.05);
        }

        .add-device-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .add-device-btn:disabled:hover {
            border-color: var(--border);
            color: var(--text-dim);
            background: transparent;
        }

        .device-counter {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 1.5rem;
        }

        .device-counter span {
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Required tags section - in mapping */
        .required-tag-input {
            display: grid;
            grid-template-columns: 140px 1fr auto 1fr;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0;
        }

        .required-tag-input label {
            margin-bottom: 0;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-weight: 600;
        }

        .required-tag-input label::after {
            content: ' *';
            color: var(--error);
        }

        .required-tag-input input,
        .required-tag-input select {
            margin-bottom: 0;
        }

        .required-tag-input .input-or {
            color: var(--text-dim);
            font-size: 0.85rem;
            text-align: center;
        }

        @media (max-width: 700px) {
            .required-tag-input {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .required-tag-input .input-or {
                display: none;
            }
        }

        .validation-error {
            color: var(--error);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Floating action button */
        .fab-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
        }

        .fab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50px;
            color: var(--text);
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .fab:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 170, 0.2);
        }

        .fab-icon {
            font-size: 1.2rem;
        }

        /* Gus Signature Footer - Geek Style */
        .gus-footer {
            margin-top: 3rem;
            padding: 1rem 0;
        }

        .gus-signature {
            display: inline-block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem;
            line-height: 1.15;
            color: var(--text-dim);
            white-space: pre;
            text-align: left;
            cursor: default;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            position: relative;
            overflow: hidden;
            opacity: 0.6;
            transition: all 0.4s ease;
        }

        /* Scanline effect */
        .gus-signature::before {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(
                transparent 0%,
                rgba(0, 212, 170, 0.03) 50%,
                transparent 100%
            );
            animation: scanline 4s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% { top: -100%; }
            100% { top: 100%; }
        }

        /* Border glow on hover */
        .gus-signature::after {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            border-radius: 8px;
            background: linear-gradient(45deg, var(--accent), transparent, var(--accent));
            background-size: 200% 200%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s;
        }

        .gus-signature:hover {
            opacity: 1;
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.15), inset 0 0 30px rgba(0, 212, 170, 0.03);
            transform: translateY(-2px);
        }

        .gus-signature:hover::after {
            opacity: 1;
            animation: border-glow 2s linear infinite;
        }

        @keyframes border-glow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .gus-signature .gus-ascii {
            color: var(--accent);
            text-shadow: 0 0 5px rgba(0, 212, 170, 0.3);
            display: block;
        }

        .gus-signature .gus-line {
            color: var(--border);
        }

        .gus-signature .gus-title {
            color: var(--text);
            letter-spacing: 0.15em;
        }

        .gus-signature .gus-bullet {
            color: var(--accent);
        }

        .gus-signature .gus-warning {
            color: var(--warning);
        }

        /* Typing cursor effect on hover */
        .gus-signature:hover .gus-cursor {
            animation: blink 1s step-end infinite;
        }

        .gus-cursor {
            color: var(--accent);
            opacity: 0;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Terminal prompt style */
        .gus-prompt {
            color: var(--accent);
            opacity: 0.7;
        }

        /* ==================== TOOLS HUB ==================== */
        .tools-hub-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
            max-width: 900px;
            margin: 0 auto;
        }

        @media (max-width: 900px) {
            .tools-hub-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .tools-hub-grid { grid-template-columns: 1fr; }
        }

        .tool-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tool-card:hover {
            border-color: rgba(0, 212, 170, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 212, 170, 0.1);
            transform: translateY(-4px);
        }

        .tool-card:hover::before {
            opacity: 1;
        }

        .tool-card svg {
            width: 40px;
            height: 40px;
            color: var(--accent);
            margin-bottom: 0.75rem;
        }

        .tool-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: var(--text);
        }

        .tool-card p {
            font-size: 0.8rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        .tool-subview {
            max-width: 900px;
            margin: 0 auto;
        }

        .tool-subview-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .tool-subview-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
        }

        .btn-back {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }

        .btn-back:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error), #ff3333);
            color: #fff;
            border: none;
            box-shadow: 0 2px 10px rgba(255, 92, 92, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 92, 92, 0.4);
        }

        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.75rem 0;
            border: 1px solid var(--border);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #00e6b8);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.5rem;
        }

        /* Delete tool */
        .delete-search {
            width: 100%;
            padding: 0.6rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .delete-search:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        .delete-actions-bar {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .selection-count {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        .device-checkbox {
            width: auto !important;
            margin: 0 !important;
            cursor: pointer;
        }

        /* Warning box */
        .warning-box {
            background: rgba(255, 184, 77, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            color: var(--warning);
            margin-bottom: 1rem;
        }

        /* Tag update drop zone */
        .drop-zone-small {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .drop-zone-small:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.1);
        }

        .drop-zone-small svg {
            width: 32px;
            height: 32px;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .drop-zone-small p {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .mode-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .mode-selector label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .mode-selector label:hover {
            border-color: var(--accent);
        }

        .mode-selector input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .mode-selector input[type="radio"]:checked + span {
            color: var(--accent);
        }
    </style>
</head>
<body>
    <!-- LoRa Signal Background Animation -->
    <div class="lora-bg">
        <!-- Device 1 (bottom left) -->
        <div class="lora-device"></div>
        <div class="signal-wave"></div>
        <div class="signal-wave"></div>
        <div class="signal-wave"></div>
        <div class="signal-wave"></div>
        <div class="signal-dot"></div>
        <div class="signal-dot"></div>
        <div class="signal-dot"></div>

        <!-- Device 2 (bottom right) -->
        <div class="lora-device-2"></div>
        <div class="signal-wave-2"></div>
        <div class="signal-wave-2"></div>
        <div class="signal-wave-2"></div>
        <div class="signal-wave-2"></div>
        <div class="signal-dot-2"></div>
        <div class="signal-dot-2"></div>

        <!-- Gateway (top right) -->
        <div class="lora-gateway"></div>
        <div class="gateway-pulse"></div>
        <div class="gateway-pulse"></div>
    </div>

    <div class="container">
        <header>
            <h1>ChirpStack Device Manager</h1>
            <p>Import, export et gestion de devices LoRaWAN</p>
        </header>

        <!-- Stepper -->
        <div class="stepper">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <span class="step-label">Connexion</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <span class="step-label">Application</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <span class="step-label">Outils</span>
            </div>
        </div>

        <!-- Step 1: Connexion API + Tenant -->
        <div class="step-content active" id="step1">
            <div class="card card-centered">
                <h2>Connexion Ã  ChirpStack</h2>
                <div class="info-box" id="infoBox">
                    Pour obtenir un token API, allez dans ChirpStack &gt; <code>API Keys</code> &gt; Create
                </div>

                <label for="apiUrl">URL ChirpStack</label>
                <div class="server-input-group">
                    <div class="server-input-wrapper">
                        <input type="text" id="apiUrl" placeholder="http://localhost:8090" value="http://localhost:8090">
                        <button class="server-select-btn" onclick="toggleServerDropdown()" title="Serveurs sauvegardÃ©s">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="server-dropdown hidden" id="serverDropdown">
                            <div class="server-dropdown-header">Serveurs sauvegardÃ©s</div>
                            <div id="serverDropdownList">
                                <div class="server-dropdown-empty">Aucun serveur sauvegardÃ©</div>
                            </div>
                        </div>
                    </div>
                    <button class="save-server-btn" onclick="openSaveServerModal()" title="Sauvegarder ce serveur">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                </div>

                <label for="apiToken">Token API</label>
                <input type="password" id="apiToken" placeholder="Votre token (sans Bearer)...">

                <!-- Tenant selection - shown after connection test -->
                <div id="tenantSection" class="hidden">
                    <label for="tenantSelect">Tenant</label>
                    <div class="select-wrapper">
                        <select id="tenantSelect" onchange="onTenantSelected()">
                            <option value="">-- SÃ©lectionnez un tenant --</option>
                        </select>
                    </div>
                </div>

                <!-- Manual tenant ID - shown if not admin -->
                <div id="tenantManualSection" class="hidden">
                    <label for="tenantId">Tenant ID <span style="color: var(--text-dim); font-weight: normal;">(clÃ© non-admin dÃ©tectÃ©e)</span></label>
                    <input type="text" id="tenantId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    <div class="info-box" style="margin-top: -0.5rem;">
                        Le Tenant ID se trouve dans l'URL : <code>/#/tenants/<strong>TENANT_ID</strong>/...</code>
                    </div>
                </div>

                <div id="connectionStatus"></div>

                <!-- Tenant Dashboard - shown after successful connection -->
                <div id="tenantDashboard" class="tenant-dashboard hidden">
                    <h4>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Dashboard Tenant
                    </h4>
                    <div class="dashboard-grid">
                        <div class="dashboard-stat active">
                            <div class="dashboard-stat-value" id="dashActiveDevices">-</div>
                            <div class="dashboard-stat-label">Devices actifs</div>
                        </div>
                        <div class="dashboard-stat inactive">
                            <div class="dashboard-stat-value" id="dashInactiveDevices">-</div>
                            <div class="dashboard-stat-label">Inactifs</div>
                        </div>
                        <div class="dashboard-stat never">
                            <div class="dashboard-stat-value" id="dashNeverSeenDevices">-</div>
                            <div class="dashboard-stat-label">Jamais vus</div>
                        </div>
                        <div class="dashboard-stat gateway">
                            <div class="dashboard-stat-value" id="dashActiveGateways">-</div>
                            <div class="dashboard-stat-label">Gateways</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; text-align: center;">
                    <button class="btn-primary" id="btnTestConnection" onclick="testConnection()">Tester la connexion</button>
                    <button class="btn-primary hidden" id="btnContinueStep2" onclick="continueToStep2()">Continuer</button>
                </div>
            </div>
        </div>

        <!-- Step 2: SÃ©lection Application -->
        <div class="step-content" id="step2">
            <div class="card card-centered">
                <h2>SÃ©lection de l'Application</h2>
                <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1.5rem;">
                    SÃ©lectionnez l'application cible pour vos devices.
                </p>

                <label for="applicationSelect">Application</label>
                <div class="select-wrapper">
                    <select id="applicationSelect">
                        <option value="">Chargement...</option>
                    </select>
                </div>

                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn-secondary" onclick="goToStep(1)">Retour</button>
                    <button class="btn-primary" id="btnToStep3" onclick="selectApplication()" disabled>Continuer</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Outils -->
        <div class="step-content" id="step3">

            <!-- Tools Hub -->
            <div id="toolsHub">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <p style="color: var(--text-dim); font-size: 0.9rem;">
                        Application : <span id="hubAppName" style="color: var(--accent); font-family: 'JetBrains Mono', monospace;">-</span>
                        &nbsp;|&nbsp;
                        <button class="btn-secondary btn-small" onclick="goToStep(2)" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;">Changer</button>
                    </p>
                </div>
                <div class="tools-hub-grid">
                    <div class="tool-card" onclick="showTool('import')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <h3>Import</h3>
                        <p>Importer des devices depuis un fichier CSV/XLSX ou manuellement</p>
                    </div>
                    <div class="tool-card" onclick="showTool('export')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3>Export</h3>
                        <p>Exporter les devices de l'application en CSV ou XLSX</p>
                    </div>
                    <div class="tool-card" onclick="showTool('delete')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <h3>Supprimer en masse</h3>
                        <p>Selectionner et supprimer plusieurs devices</p>
                    </div>
                    <div class="tool-card" onclick="showTool('tagUpdate')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        <h3>Mise a jour des tags</h3>
                        <p>Modifier les tags de vos devices en masse via CSV/XLSX</p>
                    </div>
                    <div class="tool-card" onclick="openTemplateModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3>Template CSV</h3>
                        <p>Telecharger un modele CSV pre-configure pour l'import</p>
                    </div>
                </div>
            </div>

            <!-- ====== IMPORT SUB-VIEW ====== -->
            <div id="importSubView" class="tool-subview hidden">
                <div class="tool-subview-header">
                    <button class="btn-back" onclick="backToToolsHub()">&#8592; Retour</button>
                    <h2>Import de devices</h2>
                </div>

            <!-- Configuration card -->
            <div class="card" style="max-width: 700px; margin: 0 auto 1.5rem auto;">
                <h2>Configuration</h2>
                <div style="font-size: 0.9rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <span style="color: var(--text-dim);">Tenant:</span>
                        <span id="summaryTenant" style="color: var(--accent); font-family: 'JetBrains Mono', monospace;">-</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <span style="color: var(--text-dim);">Application:</span>
                        <span id="summaryApp" style="color: var(--accent); font-family: 'JetBrains Mono', monospace;">-</span>
                    </div>
                </div>

                <!-- Profile selector - MANDATORY -->
                <div class="profile-selector" style="border-bottom: none; padding-bottom: 0; margin-bottom: 1rem;">
                    <div class="profile-selector-header">
                        <label for="importProfileSelect">Profil d'import <span style="color: var(--error);">*</span></label>
                        <button class="btn-icon" onclick="openProfileModal()" title="Gerer les profils">&#9881;</button>
                    </div>
                    <div class="select-wrapper">
                        <select id="importProfileSelect" onchange="onProfileSelected()">
                            <option value="">-- SÃ©lectionnez un profil --</option>
                            <option value="__none__">Sans profil (import simple)</option>
                        </select>
                    </div>
                    <p id="profileSelectionHint" style="color: var(--warning); font-size: 0.85rem; margin-top: -0.5rem;">
                        Veuillez sÃ©lectionner un profil pour continuer
                    </p>
                    <p id="profileSummary" class="hidden" style="font-size: 0.85rem; margin-top: -0.5rem; color: var(--text-dim);"></p>
                </div>

                <label for="deviceProfileSelect">Device Profile</label>
                <div class="select-wrapper">
                    <select id="deviceProfileSelect">
                        <option value="">-- Utiliser le CSV --</option>
                    </select>
                </div>
                <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: -0.5rem;">
                    Appliquer un device profile fixe ou laisser vide pour utiliser la colonne CSV
                </p>

                <div style="margin-top: 1rem;">
                    <button class="btn-secondary btn-small" onclick="goToStep(1)">Modifier connexion</button>
                </div>

                <!-- Import Mode Toggle -->
                <div class="import-mode-toggle disabled" id="importModeToggle">
                    <button class="mode-btn active" data-mode="file" onclick="setImportMode('file')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Import fichier
                    </button>
                    <button class="mode-btn" data-mode="manual" onclick="setImportMode('manual')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Ajout manuel
                    </button>
                </div>
            </div>

            <!-- Upload file card - Initially disabled -->
            <div class="card" id="fileUploadCard" style="max-width: 700px; margin: 0 auto; opacity: 0.5; pointer-events: none;">
                <h2>Fichier source</h2>
                <div class="drop-zone" id="dropZone">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p>Glissez votre fichier ici ou <strong>cliquez pour parcourir</strong></p>
                    <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.5rem;">Formats acceptÃ©s : CSV, XLS, XLSX</p>
                    <div class="filename" id="fileName"></div>
                </div>
                <input type="file" id="fileInput" accept=".csv,.xls,.xlsx" style="display: none;">

                <div id="separatorSection">
                    <label style="margin-top: 1rem; display: block;">SÃ©parateur CSV</label>
                    <div class="separator-options">
                        <label><input type="radio" name="separator" value="auto" checked> Auto</label>
                        <label><input type="radio" name="separator" value=";" > Point-virgule (;)</label>
                        <label><input type="radio" name="separator" value=","> Virgule (,)</label>
                        <label><input type="radio" name="separator" value="\t"> Tabulation</label>
                    </div>
                    <p id="detectedSeparator" style="font-size: 0.8rem; color: var(--accent); margin-top: -0.5rem; display: none;"></p>
                </div>
            </div>

            <!-- Manual Entry Container - Hidden by default -->
            <div class="manual-entry-container hidden" id="manualEntryContainer">
                <div class="card">
                    <h2>Ajout manuel de devices</h2>
                    <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
                        Ajoutez jusqu'Ã  5 devices manuellement. Pour plus, utilisez l'import fichier.
                    </p>

                    <div id="manualDevicesList">
                        <!-- Devices will be added here dynamically -->
                    </div>

                    <button class="add-device-btn" id="addDeviceBtn" onclick="addManualDevice()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Ajouter un device
                    </button>

                    <div class="device-counter">
                        <span id="deviceCount">0</span> / 5 devices
                    </div>

                    <div class="actions" style="border-top: none; padding-top: 0; margin-top: 0;">
                        <button class="btn-secondary" onclick="clearManualDevices()">Tout effacer</button>
                        <button class="btn-primary" id="importManualBtn" onclick="importManualDevices()" disabled>
                            Importer les devices
                        </button>
                    </div>
                </div>
            </div>

        <!-- Mapping Section -->
        <div class="card hidden" id="mappingSection" style="max-width: 900px; margin: 1.5rem auto;">
            <h2>Mapping des colonnes</h2>
            <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1.5rem;">
                Associez les colonnes de votre fichier aux champs ChirpStack
            </p>

            <div class="mapping-grid" id="mappingGrid">
                <div class="mapping-item">
                    <label>name</label>
                    <select data-field="name"></select>
                </div>
                <div class="mapping-item">
                    <label>description</label>
                    <select data-field="description"></select>
                </div>
                <div class="mapping-item">
                    <label>dev_eui</label>
                    <select data-field="dev_eui"></select>
                </div>
                <div class="mapping-item">
                    <label>device_profile_id</label>
                    <select data-field="device_profile_id"></select>
                </div>
                <div class="mapping-item">
                    <label>app_key (nwk_key)</label>
                    <select data-field="app_key"></select>
                </div>
            </div>

            <!-- Required tags from profile - shown only if profile has required tags -->
            <div id="requiredTagsSection" class="hidden" style="margin-top: 2rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(0, 212, 170, 0.08), rgba(0, 212, 170, 0.02)); border: 1px solid var(--accent); border-radius: 10px;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--accent); display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.1rem;">&#9733;</span>
                    <span id="requiredTagsTitle">Tags obligatoires du profil</span>
                </h3>
                <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem;">
                    Ces tags sont requis par le profil sÃ©lectionnÃ©. Renseignez une valeur fixe ou sÃ©lectionnez une colonne du fichier.
                </p>
                <div id="requiredTagsInputs"></div>
                <div id="requiredTagsError" class="validation-error hidden"></div>
            </div>

            <div style="margin-top: 2rem;">
                <h3 style="font-size: 1rem; margin-bottom: 1rem;">Tags additionnels (colonnes du fichier)</h3>
                <div class="tag-container" id="csvTagContainer"></div>

                <h3 style="font-size: 1rem; margin-bottom: 1rem; margin-top: 1.5rem;">Tags manuels (valeur fixe pour tous)</h3>
                <div class="tag-container" id="manualTagContainer"></div>
                <div class="add-tag">
                    <input type="text" id="tagKey" placeholder="ClÃ©">
                    <input type="text" id="tagValue" placeholder="Valeur">
                    <button class="btn-secondary btn-small" onclick="addManualTag()">+ Ajouter</button>
                </div>
            </div>
        </div>

        <!-- Duplicate Detection Section -->
        <div class="card hidden" id="duplicateSection" style="max-width: 900px; margin: 1.5rem auto;">
            <h2>Doublons detectes</h2>
            <p id="duplicateSummary" style="color: var(--warning); font-size: 0.9rem; margin-bottom: 1rem;"></p>
            <div class="preview-table" style="max-height: 300px; overflow-y: auto;">
                <table id="duplicateTable">
                    <thead>
                        <tr><th>DevEUI</th><th>Nom existant</th><th>Nom CSV</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="actions" style="margin-top: 1rem;">
                <button class="btn-secondary" onclick="cancelDuplicateImport()">Annuler</button>
                <button class="btn-primary" onclick="importIgnoringDuplicates()">Ignorer les doublons</button>
                <button class="btn-danger" onclick="importOverwritingDuplicates()">Ecraser (supprimer + recreer)</button>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="card preview-section hidden" id="previewSection" style="max-width: 900px; margin: 1.5rem auto;">
            <h2>AperÃ§u des donnÃ©es</h2>
            <p style="color: var(--text-dim); font-size: 0.9rem;">
                <span id="rowCount">0</span> devices Ã  importer
            </p>
            <div class="preview-table">
                <table id="previewTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions hidden" id="actionsSection" style="max-width: 900px; margin: 0 auto;">
            <button class="btn-secondary" onclick="resetAll()">RÃ©initialiser</button>
            <button class="btn-primary" id="importBtn" onclick="startImport()">
                Lancer l'import
            </button>
        </div>

        <!-- Results -->
        <div class="card hidden" id="resultsSection" style="max-width: 900px; margin: 1.5rem auto;">
            <h2>RÃ©sultats</h2>
            <div class="stats">
                <div class="stat stat-total">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat stat-success">
                    <div class="stat-value" id="statSuccess">0</div>
                    <div class="stat-label">SuccÃ¨s</div>
                </div>
                <div class="stat stat-error">
                    <div class="stat-value" id="statError">0</div>
                    <div class="stat-label">Erreurs</div>
                </div>
            </div>

            <!-- Fix Device Profile section - shown when DP is missing -->
            <div id="fixDeviceProfileSection" class="hidden" style="margin: 1.5rem 0; padding: 1rem; background: var(--bg-input); border-radius: 8px; border: 1px solid var(--warning);">
                <p style="color: var(--warning); margin-bottom: 1rem; font-weight: 500;">
                    âš  Device Profile manquant ! SÃ©lectionnez-en un et relancez l'import :
                </p>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div class="select-wrapper" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                        <select id="fixDeviceProfileSelect">
                            <option value="">-- SÃ©lectionnez un Device Profile --</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="retryWithDeviceProfile()">Relancer l'import</button>
                </div>
            </div>

            <div class="log-container" id="logContainer"></div>
        </div>
            </div><!-- End importSubView -->

            <!-- ====== EXPORT SUB-VIEW ====== -->
            <div id="exportSubView" class="tool-subview hidden">
                <div class="tool-subview-header">
                    <button class="btn-back" onclick="backToToolsHub()">&#8592; Retour</button>
                    <h2>Export de devices</h2>
                </div>
                <div class="card" style="max-width: 700px; margin: 0 auto 1.5rem auto;">
                    <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
                        Application : <span id="exportAppName" style="color: var(--accent); font-family: 'JetBrains Mono', monospace;">-</span>
                    </p>
                    <div class="checkbox-group">
                        <input type="checkbox" id="exportIncludeKeys">
                        <label for="exportIncludeKeys" style="margin-bottom: 0;">Inclure les cles (nwkKey / appKey)</label>
                    </div>
                    <div class="warning-box hidden" id="exportKeysWarning">
                        Les cles seront visibles en clair dans le fichier exporte. Ne partagez pas ce fichier sans precaution.
                    </div>
                    <label>Format d'export</label>
                    <div class="mode-selector">
                        <label><input type="radio" name="exportFormat" value="csv" checked> <span>CSV</span></label>
                        <label><input type="radio" name="exportFormat" value="xlsx"> <span>XLSX (Excel)</span></label>
                    </div>
                    <button class="btn-primary" id="btnLoadExport" onclick="loadDevicesForExport()">Charger les devices</button>
                    <div id="exportProgress" class="hidden" style="margin-top: 1rem;">
                        <p class="progress-text" id="exportProgressText">Chargement...</p>
                        <div class="progress-bar"><div class="progress-bar-fill" id="exportProgressBar"></div></div>
                    </div>
                </div>
                <div class="card hidden" id="exportPreviewCard" style="max-width: 900px; margin: 0 auto 1.5rem auto;">
                    <h2>Apercu</h2>
                    <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
                        <span id="exportDeviceCount">0</span> devices charges
                    </p>
                    <div class="preview-table" style="max-height: 300px; overflow-y: auto;">
                        <table id="exportPreviewTable"><thead></thead><tbody></tbody></table>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button class="btn-primary" onclick="downloadExport()">Telecharger</button>
                    </div>
                </div>
            </div>

            <!-- ====== DELETE SUB-VIEW ====== -->
            <div id="deleteSubView" class="tool-subview hidden">
                <div class="tool-subview-header">
                    <button class="btn-back" onclick="backToToolsHub()">&#8592; Retour</button>
                    <h2>Suppression en masse</h2>
                </div>
                <div class="card" style="max-width: 900px; margin: 0 auto 1.5rem auto;">
                    <button class="btn-primary" id="btnLoadDelete" onclick="loadDevicesForDelete()">Charger les devices</button>
                    <div id="deleteProgress" class="hidden" style="margin-top: 1rem;">
                        <p class="progress-text" id="deleteProgressText">Chargement...</p>
                        <div class="progress-bar"><div class="progress-bar-fill" id="deleteProgressBar"></div></div>
                    </div>
                </div>
                <div class="card hidden" id="deleteListCard" style="max-width: 900px; margin: 0 auto 1.5rem auto;">
                    <input type="text" class="delete-search" placeholder="Rechercher par nom ou DevEUI..." oninput="filterDeleteList(this.value)">
                    <div class="delete-actions-bar">
                        <button class="btn-secondary btn-small" onclick="selectAllForDeletion()">Tout selectionner</button>
                        <button class="btn-secondary btn-small" onclick="deselectAll()">Tout deselectionner</button>
                        <span class="selection-count"><span id="deleteSelectionCount">0</span> device(s) selectionne(s)</span>
                    </div>
                    <div class="preview-table" style="max-height: 400px; overflow-y: auto;">
                        <table id="deleteTable">
                            <thead>
                                <tr><th style="width:40px;"></th><th>Nom</th><th>DevEUI</th><th>Profil</th><th>Dernier vu</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button class="btn-danger" id="btnBulkDelete" onclick="confirmBulkDelete()" disabled>Supprimer la selection</button>
                    </div>
                </div>
                <div class="card hidden" id="deleteResultsCard" style="max-width: 900px; margin: 0 auto 1.5rem auto;">
                    <h2>Resultats de suppression</h2>
                    <div id="deleteResultProgress" class="hidden" style="margin-bottom: 1rem;">
                        <p class="progress-text" id="deleteResultProgressText">Suppression...</p>
                        <div class="progress-bar"><div class="progress-bar-fill" id="deleteResultProgressBar"></div></div>
                    </div>
                    <div class="log-container" id="deleteLogContainer"></div>
                </div>
            </div>

            <!-- ====== TAG UPDATE SUB-VIEW ====== -->
            <div id="tagUpdateSubView" class="tool-subview hidden">
                <div class="tool-subview-header">
                    <button class="btn-back" onclick="backToToolsHub()">&#8592; Retour</button>
                    <h2>Mise a jour des tags</h2>
                </div>
                <div class="card" style="max-width: 700px; margin: 0 auto 1.5rem auto;">
                    <div class="info-box" style="margin-bottom: 1rem;">
                        Importez un fichier CSV/XLSX contenant une colonne <code>dev_eui</code> et des colonnes de tags.
                        Les tags seront mis a jour pour chaque device trouve.
                    </div>
                    <label>Mode de mise a jour</label>
                    <div class="mode-selector">
                        <label><input type="radio" name="tagUpdateMode" value="merge" checked> <span>Fusionner (ajouter/modifier)</span></label>
                        <label><input type="radio" name="tagUpdateMode" value="replace"> <span>Remplacer (supprimer les anciens)</span></label>
                    </div>
                    <div class="drop-zone-small" id="tagUpdateDropZone">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p>Glissez votre fichier ou <strong>cliquez pour parcourir</strong></p>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.3rem;">CSV, XLS, XLSX</p>
                        <div class="filename" id="tagUpdateFileName"></div>
                    </div>
                    <input type="file" id="tagUpdateFileInput" accept=".csv,.xls,.xlsx" style="display: none;">
                </div>
                <div class="card hidden" id="tagUpdatePreviewCard" style="max-width: 900px; margin: 0 auto 1.5rem auto;">
                    <h2>Apercu des modifications</h2>
                    <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 0.5rem;">
                        <span id="tagUpdateCount">0</span> devices a modifier â€” Colonnes de tags : <span id="tagUpdateCols" style="color: var(--accent); font-family: 'JetBrains Mono', monospace;">-</span>
                    </p>
                    <div class="preview-table" style="max-height: 300px; overflow-y: auto;">
                        <table id="tagUpdatePreviewTable"><thead></thead><tbody></tbody></table>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button class="btn-primary" onclick="startTagUpdate()">Lancer la mise a jour</button>
                    </div>
                </div>
                <div class="card hidden" id="tagUpdateResultsCard" style="max-width: 900px; margin: 0 auto 1.5rem auto;">
                    <h2>Resultats</h2>
                    <div id="tagUpdateProgress" class="hidden" style="margin-bottom: 1rem;">
                        <p class="progress-text" id="tagUpdateProgressText">Mise a jour...</p>
                        <div class="progress-bar"><div class="progress-bar-fill" id="tagUpdateProgressBar"></div></div>
                    </div>
                    <div class="log-container" id="tagUpdateLogContainer"></div>
                </div>
            </div>

        </div><!-- End step3 -->
    </div>

    <!-- Floating Action Button for Profiles -->
    <div class="fab-container">
        <button class="fab" onclick="openProfileModal()" title="Gerer les profils d'import">
            <span class="fab-icon">&#9881;</span>
            <span>Profils</span>
        </button>
    </div>

    <!-- Save Server Modal -->
    <div class="save-server-modal-backdrop hidden" id="saveServerBackdrop" onclick="closeSaveServerModal()"></div>
    <div class="save-server-modal hidden" id="saveServerModal">
        <h3>Sauvegarder le serveur</h3>

        <label for="serverUrlInput">URL du serveur</label>
        <input type="text" id="serverUrlInput" placeholder="http://192.168.1.10:8080">

        <label for="serverName">Nom (pour l'identifier)</label>
        <input type="text" id="serverName" placeholder="Ex: Production, Test, Dev...">

        <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: -0.5rem; margin-bottom: 1rem;">
            âš  Seule l'URL est sauvegardÃ©e, jamais le token.
        </p>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
            <button class="btn-secondary btn-small" onclick="closeSaveServerModal()">Annuler</button>
            <button class="btn-primary btn-small" onclick="saveServer()">Sauvegarder</button>
        </div>
    </div>

    <!-- Template CSV Modal -->
    <div class="modal-overlay hidden" id="templateModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Template CSV</h2>
                <button class="modal-close" onclick="closeTemplateModal()">&times;</button>
            </div>
            <label for="templateDpSelect">Device Profile (optionnel)</label>
            <div class="select-wrapper">
                <select id="templateDpSelect">
                    <option value="">-- Aucun (colonne device_profile_id incluse) --</option>
                </select>
            </div>
            <label for="templateProfileSelect">Profil d'import (optionnel)</label>
            <div class="select-wrapper">
                <select id="templateProfileSelect">
                    <option value="">-- Aucun --</option>
                </select>
            </div>
            <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 1rem;">
                Le template contiendra les colonnes de base + les tags du profil selectionne.
            </p>
            <div style="text-align: center;">
                <button class="btn-primary" onclick="downloadCsvTemplate()">Telecharger le template</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay hidden" id="deleteConfirmModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2>Confirmer la suppression</h2>
                <button class="modal-close" onclick="closeDeleteConfirmModal()">&times;</button>
            </div>
            <p style="color: var(--error); font-size: 0.95rem; margin-bottom: 1rem;">
                Vous allez supprimer <strong id="deleteConfirmCount">0</strong> device(s). Cette action est irreversible.
            </p>
            <label for="deleteConfirmInput">Tapez le nombre <strong id="deleteConfirmNumber" style="color: var(--error);">0</strong> pour confirmer :</label>
            <input type="text" id="deleteConfirmInput" placeholder="..." style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button class="btn-secondary btn-small" onclick="closeDeleteConfirmModal()">Annuler</button>
                <button class="btn-danger btn-small" onclick="executeBulkDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Profile Management Modal -->
    <div class="modal-overlay hidden" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Gestion des profils d'import</h2>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>

            <!-- Existing profiles list -->
            <div class="profile-list" id="profileList">
                <p style="color: var(--text-dim); font-size: 0.9rem;">Aucun profil enregistre</p>
            </div>

            <!-- Create/Edit form -->
            <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                <h3 style="font-size: 1rem; margin-bottom: 1rem;" id="profileFormTitle">Nouveau profil</h3>

                <label for="profileName">Nom du profil</label>
                <input type="text" id="profileName" placeholder="Ex: Import Client A">

                <label>Tags obligatoires</label>
                <div class="tag-input-container" id="tagInputContainer" onclick="focusTagInput()">
                    <input type="text" class="tag-input" id="newTagInput" placeholder="Tapez un tag et appuyez sur Entree..." onkeydown="handleTagInput(event)">
                </div>
                <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: -0.5rem; margin-bottom: 1rem;">
                    Ces tags devront etre renseignes lors de chaque import utilisant ce profil
                </p>

                <input type="hidden" id="editingProfileId" value="">

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="resetProfileForm()">Annuler</button>
                    <button class="btn-primary" onclick="saveProfile()" id="saveProfileBtn">Creer le profil</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let currentStep = 1;
        let csvData = [];
        let csvHeaders = [];
        let manualTags = {};
        let csvTags = [];
        let currentFile = null; // Store uploaded file for separator changes

        // API data
        let applications = [];
        let deviceProfiles = [];
        let selectedTenantId = '';
        let selectedApplicationId = '';
        let selectedApplicationName = '';

        // Profiles
        let profiles = [];
        let selectedProfile = null;
        let profileFormTags = []; // Tags being edited in the form
        let requiredTagValues = {}; // Values for required tags when importing

        // ==================== STEPPER ====================
        function goToStep(step) {
            currentStep = step;

            // Update step content visibility
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');

            // Update stepper visual
            document.querySelectorAll('.step').forEach(el => {
                const stepNum = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (stepNum === step) el.classList.add('active');
                if (stepNum < step) el.classList.add('completed');
            });

            // Update connectors
            document.querySelectorAll('.step-connector').forEach((el, i) => {
                el.classList.toggle('completed', i < step - 1);
            });
        }

        // ==================== API HELPERS ====================
        function getApiUrl() {
            return document.getElementById('apiUrl').value.trim().replace(/\/$/, '');
        }

        function getApiToken() {
            let token = document.getElementById('apiToken').value.trim();
            // Remove "Bearer " prefix if user included it
            if (token.toLowerCase().startsWith('bearer ')) {
                token = token.substring(7);
            }
            return token;
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            // Use proxy to avoid CORS issues
            const baseUrl = getApiUrl();
            const url = `/proxy/${baseUrl}${endpoint}`;
            const options = {
                method,
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Grpc-Metadata-Authorization': `Bearer ${getApiToken()}`
                }
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(url, options);
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`${response.status}: ${text}`);
            }
            const text = await response.text();
            return text ? JSON.parse(text) : {};
        }

        function setConnectionStatus(type, message) {
            const el = document.getElementById('connectionStatus');
            if (type === 'loading') {
                el.innerHTML = `<div class="connection-status loading"><div class="spinner"></div>${message}</div>`;
            } else if (type === 'success') {
                el.innerHTML = `<div class="connection-status success">âœ“ ${message}</div>`;
            } else if (type === 'error') {
                el.innerHTML = `<div class="connection-status error">âœ— ${message}</div>`;
            } else {
                el.innerHTML = '';
            }
        }

        // ==================== STEP 1: CONNECTION ====================
        let isAdminKey = false;
        let tenants = [];

        function getTenantId() {
            // Get from select if admin, otherwise from manual input
            if (isAdminKey) {
                return document.getElementById('tenantSelect').value;
            }
            return document.getElementById('tenantId').value.trim();
        }

        async function testConnection() {
            const apiUrl = getApiUrl();
            const apiToken = getApiToken();

            if (!apiUrl || !apiToken) {
                alert('Veuillez remplir l\'URL et le token API');
                return;
            }

            setConnectionStatus('loading', 'Test de connexion...');

            // Hide tenant sections initially
            document.getElementById('tenantSection').classList.add('hidden');
            document.getElementById('tenantManualSection').classList.add('hidden');
            document.getElementById('btnContinueStep2').classList.add('hidden');
            hideTenantDashboard();

            try {
                // Try to fetch tenants (works only with admin key)
                const data = await apiCall('/api/tenants?limit=100');
                tenants = data.result || [];
                isAdminKey = true;

                if (tenants.length === 0) {
                    setConnectionStatus('error', 'Connexion OK mais aucun tenant trouvÃ©');
                    return;
                }

                setConnectionStatus('success', `ClÃ© admin dÃ©tectÃ©e ! ${tenants.length} tenant(s) disponible(s)`);

                // Populate tenant select
                const select = document.getElementById('tenantSelect');
                select.innerHTML = '<option value="">-- SÃ©lectionnez un tenant --</option>' +
                    tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

                // Show tenant select
                document.getElementById('tenantSection').classList.remove('hidden');
                document.getElementById('btnTestConnection').classList.add('hidden');
                document.getElementById('btnContinueStep2').classList.remove('hidden');

            } catch (err) {
                // If 401, it's a tenant-specific key
                if (err.message.includes('401')) {
                    isAdminKey = false;
                    setConnectionStatus('success', 'ClÃ© tenant dÃ©tectÃ©e. Entrez votre Tenant ID ci-dessous.');

                    // Show manual tenant ID input
                    document.getElementById('tenantManualSection').classList.remove('hidden');
                    document.getElementById('btnTestConnection').classList.add('hidden');
                    document.getElementById('btnContinueStep2').classList.remove('hidden');
                } else {
                    setConnectionStatus('error', `Ã‰chec de connexion: ${err.message}`);
                }
            }
        }

        async function continueToStep2() {
            selectedTenantId = getTenantId();

            if (!selectedTenantId) {
                alert('Veuillez sÃ©lectionner ou saisir un Tenant ID');
                return;
            }

            // Load dashboard if not already shown (for tenant keys)
            if (!isAdminKey) {
                loadTenantDashboard(selectedTenantId);
            }

            setConnectionStatus('loading', 'Chargement des applications...');

            try {
                // Fetch applications for this tenant
                const appData = await apiCall(`/api/applications?tenant_id=${selectedTenantId}&limit=100`);
                applications = appData.result || [];

                // Fetch device profiles for this tenant
                const dpData = await apiCall(`/api/device-profiles?tenant_id=${selectedTenantId}&limit=100`);
                deviceProfiles = dpData.result || [];

                setConnectionStatus('success', `${applications.length} application(s), ${deviceProfiles.length} device profile(s)`);

                // Populate application select
                const appSelect = document.getElementById('applicationSelect');
                if (applications.length === 0) {
                    appSelect.innerHTML = '<option value="">Aucune application trouvÃ©e</option>';
                } else {
                    appSelect.innerHTML = '<option value="">-- SÃ©lectionnez une application --</option>' +
                        applications.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                }

                // Populate device profile select
                const dpSelect = document.getElementById('deviceProfileSelect');
                dpSelect.innerHTML = '<option value="">-- Utiliser le CSV ou laisser vide --</option>' +
                    deviceProfiles.map(dp => `<option value="${dp.id}">${dp.name}</option>`).join('');

                // Go to step 2
                setTimeout(() => goToStep(2), 500);

            } catch (err) {
                setConnectionStatus('error', `Erreur: ${err.message}`);
            }
        }

        // ==================== STEP 2: APPLICATION ====================
        document.getElementById('applicationSelect').addEventListener('change', function() {
            document.getElementById('btnToStep3').disabled = !this.value;
        });

        function selectApplication() {
            const appSelect = document.getElementById('applicationSelect');

            selectedApplicationId = appSelect.value;
            selectedApplicationName = appSelect.options[appSelect.selectedIndex].text;

            if (!selectedApplicationId) return;

            // Update summary
            document.getElementById('summaryTenant').textContent = selectedTenantId.substring(0, 8) + '...';
            document.getElementById('summaryApp').textContent = selectedApplicationName;

            // Update hub app name
            document.getElementById('hubAppName').textContent = selectedApplicationName;

            // Populate device profile select for step 3
            const dpSelect = document.getElementById('deviceProfileSelect');
            if (deviceProfiles.length === 0) {
                dpSelect.innerHTML = '<option value="">Aucun Device Profile disponible</option>';
            } else {
                dpSelect.innerHTML = '<option value="">-- SÃ©lectionnez (ou utilisez CSV) --</option>' +
                    deviceProfiles.map(dp => `<option value="${dp.id}">${dp.name}</option>`).join('');
            }

            // Show hub (not a specific tool)
            backToToolsHub();
            goToStep(3);
        }

        function getSelectedDeviceProfile() {
            const dpSelect = document.getElementById('deviceProfileSelect');
            return {
                id: dpSelect.value,
                name: dpSelect.value ? dpSelect.options[dpSelect.selectedIndex].text : 'Depuis CSV'
            };
        }

        // ==================== STEP 4: CSV IMPORT ====================
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const mappingSection = document.getElementById('mappingSection');
        const previewSection = document.getElementById('previewSection');
        const actionsSection = document.getElementById('actionsSection');
        const resultsSection = document.getElementById('resultsSection');

        // File Upload Handling
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        function getSeparator() {
            const selected = document.querySelector('input[name="separator"]:checked');
            if (selected.value === 'auto') {
                return detectedSeparator || ';';
            }
            return selected.value === '\\t' ? '\t' : selected.value;
        }

        let detectedSeparator = null;
        let currentFileType = null; // 'csv' or 'excel'

        function detectSeparator(content) {
            // Take first few lines for analysis
            const lines = content.split('\n').slice(0, 5).filter(line => line.trim());
            if (lines.length === 0) return ';';

            const separators = [';', ',', '\t'];
            const scores = {};

            for (const sep of separators) {
                scores[sep] = 0;
                const counts = lines.map(line => {
                    // Count occurrences outside of quoted strings
                    let count = 0;
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        if (line[i] === '"') inQuotes = !inQuotes;
                        else if (line[i] === sep && !inQuotes) count++;
                    }
                    return count;
                });

                // Check if all lines have the same number of separators (consistency)
                const uniqueCounts = [...new Set(counts)];
                if (uniqueCounts.length === 1 && counts[0] > 0) {
                    scores[sep] = counts[0] * 10; // High score for consistency
                } else if (counts.every(c => c > 0)) {
                    scores[sep] = Math.min(...counts);
                }
            }

            // Return the separator with highest score
            let bestSep = ';';
            let bestScore = 0;
            for (const sep of separators) {
                if (scores[sep] > bestScore) {
                    bestScore = scores[sep];
                    bestSep = sep;
                }
            }

            return bestSep;
        }

        function getSeparatorName(sep) {
            switch(sep) {
                case ';': return 'point-virgule (;)';
                case ',': return 'virgule (,)';
                case '\t': return 'tabulation';
                default: return sep;
            }
        }

        function handleFile(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            const validExtensions = ['csv', 'xls', 'xlsx'];

            if (!validExtensions.includes(extension)) {
                alert('Veuillez sÃ©lectionner un fichier CSV, XLS ou XLSX');
                return;
            }

            currentFile = file;
            document.getElementById('fileName').textContent = file.name;

            const separatorSection = document.getElementById('separatorSection');
            const detectedSeparatorEl = document.getElementById('detectedSeparator');

            if (extension === 'csv') {
                currentFileType = 'csv';
                separatorSection.style.display = 'block';

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;

                    // Auto-detect separator if "Auto" is selected
                    const selected = document.querySelector('input[name="separator"]:checked');
                    if (selected.value === 'auto') {
                        detectedSeparator = detectSeparator(content);
                        detectedSeparatorEl.textContent = `SÃ©parateur dÃ©tectÃ© : ${getSeparatorName(detectedSeparator)}`;
                        detectedSeparatorEl.style.display = 'block';
                    } else {
                        detectedSeparatorEl.style.display = 'none';
                    }

                    parseCSV(content);
                };
                reader.readAsText(file);
            } else {
                // Excel file (xls or xlsx)
                currentFileType = 'excel';
                separatorSection.style.display = 'none';
                detectedSeparatorEl.style.display = 'none';

                const reader = new FileReader();
                reader.onload = (e) => {
                    parseExcel(e.target.result);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function parseExcel(arrayBuffer) {
            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                // Get the first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert to JSON (array of arrays)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                if (jsonData.length < 2) {
                    alert('Le fichier Excel doit contenir au moins une ligne d\'en-tÃªte et une ligne de donnÃ©es');
                    return;
                }

                // First row is headers
                csvHeaders = jsonData[0].map(h => String(h).trim());

                // Rest is data
                csvData = jsonData.slice(1).map(row => {
                    const rowObj = {};
                    csvHeaders.forEach((header, i) => {
                        rowObj[header] = row[i] !== undefined ? String(row[i]).trim() : '';
                    });
                    return rowObj;
                }).filter(row => Object.values(row).some(v => v !== '')); // Remove empty rows

                populateMappingSelects();
                populateRequiredTagsSection();
                updatePreview();

                mappingSection.classList.remove('hidden');
                previewSection.classList.remove('hidden');
                actionsSection.classList.remove('hidden');

            } catch (err) {
                console.error('Excel parsing error:', err);
                alert('Erreur lors de la lecture du fichier Excel : ' + err.message);
            }
        }

        function parseCSV(content) {
            const separator = getSeparator();
            const lines = content.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                alert('Le fichier CSV doit contenir au moins une ligne d\'en-tÃªte et une ligne de donnÃ©es');
                return;
            }

            csvHeaders = parseCSVLine(lines[0], separator);
            csvData = lines.slice(1).map(line => {
                const values = parseCSVLine(line, separator);
                const row = {};
                csvHeaders.forEach((header, i) => {
                    row[header] = (values[i] || '').replace(/[\r\n]/g, ' ').trim();
                });
                return row;
            });

            populateMappingSelects();
            populateRequiredTagsSection();
            updatePreview();

            mappingSection.classList.remove('hidden');
            previewSection.classList.remove('hidden');
            actionsSection.classList.remove('hidden');
        }

        function parseCSVLine(line, separator) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function populateMappingSelects() {
            const selects = document.querySelectorAll('#mappingGrid select');
            const options = '<option value="">-- Non mappÃ© --</option>' +
                csvHeaders.map(h => `<option value="${h}">${h}</option>`).join('');

            selects.forEach(select => {
                select.innerHTML = options;
                // Auto-detect mapping
                const field = select.dataset.field.toLowerCase();
                const match = csvHeaders.find(h => {
                    const hLower = h.toLowerCase().replace(/[_\s-]/g, '');
                    return hLower.includes(field.replace(/[_\s-]/g, '')) ||
                           (field === 'dev_eui' && hLower.includes('deveui')) ||
                           (field === 'app_key' && (hLower.includes('appkey') || hLower.includes('nwkkey')));
                });
                if (match) select.value = match;

                select.addEventListener('change', updatePreview);
            });

            // Populate CSV tags selection
            const tagContainer = document.getElementById('csvTagContainer');
            tagContainer.innerHTML = csvHeaders.map(h => `
                <label class="tag" style="cursor: pointer;">
                    <input type="checkbox" value="${h}" onchange="updateCsvTags()">
                    <span class="tag-key">${h}</span>
                </label>
            `).join('');
        }

        function updateCsvTags() {
            csvTags = Array.from(document.querySelectorAll('#csvTagContainer input:checked'))
                .map(cb => cb.value);
            updatePreview();
        }

        function addManualTag() {
            const key = document.getElementById('tagKey').value.trim();
            const value = document.getElementById('tagValue').value.trim();

            if (key && value) {
                manualTags[key] = value;
                renderManualTags();
                document.getElementById('tagKey').value = '';
                document.getElementById('tagValue').value = '';
                updatePreview();
            }
        }

        function removeManualTag(key) {
            delete manualTags[key];
            renderManualTags();
            updatePreview();
        }

        function renderManualTags() {
            const container = document.getElementById('manualTagContainer');
            container.innerHTML = Object.entries(manualTags).map(([k, v]) => `
                <div class="tag">
                    <span class="tag-key">${k}</span>
                    <span class="tag-value">= ${v}</span>
                    <button onclick="removeManualTag('${k}')">&times;</button>
                </div>
            `).join('');
        }

        function getMapping() {
            const mapping = {};
            document.querySelectorAll('#mappingGrid select').forEach(select => {
                if (select.value) {
                    mapping[select.dataset.field] = select.value;
                }
            });
            return mapping;
        }

        function updatePreview() {
            const mapping = getMapping();
            const thead = document.querySelector('#previewTable thead');
            const tbody = document.querySelector('#previewTable tbody');

            const displayFields = ['name', 'dev_eui', 'app_key'];
            const headers = displayFields.filter(f => mapping[f]).map(f => f);
            if (selectedProfile && selectedProfile.requiredTags.length) headers.push('tags (profil)');
            if (csvTags.length) headers.push('tags (CSV)');
            if (Object.keys(manualTags).length) headers.push('tags (manuels)');

            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            const previewRows = csvData.slice(0, 5);
            tbody.innerHTML = previewRows.map(row => {
                const cells = displayFields
                    .filter(f => mapping[f])
                    .map(f => `<td>${row[mapping[f]] || '-'}</td>`);

                if (selectedProfile && selectedProfile.requiredTags.length) {
                    const profileTags = getRequiredTagsForRow(row);
                    const tagsStr = Object.entries(profileTags).map(([k,v]) => `${k}: ${v || '?'}`).join(', ');
                    cells.push(`<td>${tagsStr || '-'}</td>`);
                }
                if (csvTags.length) {
                    const tags = csvTags.map(t => `${t}: ${row[t] || ''}`).join(', ');
                    cells.push(`<td>${tags}</td>`);
                }
                if (Object.keys(manualTags).length) {
                    cells.push(`<td>${Object.entries(manualTags).map(([k,v]) => `${k}: ${v}`).join(', ')}</td>`);
                }

                return `<tr>${cells.join('')}</tr>`;
            }).join('');

            document.getElementById('rowCount').textContent = csvData.length;
        }

        let hasDeviceProfileError = false;
        let failedRows = []; // Store failed rows for retry

        async function startImport(retryMode = false) {
            const mapping = getMapping();
            if (!mapping.dev_eui) {
                alert('Le mapping dev_eui est obligatoire');
                return;
            }

            // Validate required tags from selected profile
            if (!validateRequiredTags()) {
                return;
            }

            // Check for duplicates before import (only on first run, not retry)
            if (!retryMode) {
                document.getElementById('importBtn').disabled = true;
                resultsSection.classList.remove('hidden');
                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = '';

                const hasDupes = await checkDuplicates();
                if (hasDupes) {
                    showDuplicateSection();
                    return; // User will choose action via buttons
                }
                resultsSection.classList.add('hidden');
            }

            resultsSection.classList.remove('hidden');
            document.getElementById('fixDeviceProfileSection').classList.add('hidden');
            const logContainer = document.getElementById('logContainer');

            if (!retryMode) {
                logContainer.innerHTML = '';
                failedRows = [];
                hasDeviceProfileError = false;
            }

            let success = 0;
            let errors = 0;
            const rowsToProcess = retryMode ? failedRows : csvData;
            const total = rowsToProcess.length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('importBtn').disabled = true;

            if (retryMode) {
                log(`\nâ”€â”€ Relance avec Device Profile: ${getSelectedDeviceProfile().name} â”€â”€`, 'info');
                failedRows = []; // Reset for this retry
            }

            for (let i = 0; i < rowsToProcess.length; i++) {
                const row = rowsToProcess[i];
                const devEui = row[mapping.dev_eui];
                const deviceName = row[mapping.name] || devEui;

                // Build tags: profile required tags + manual tags + csv tags
                const profileTags = getRequiredTagsForRow(row);
                const tags = { ...profileTags, ...manualTags };
                csvTags.forEach(tagCol => {
                    if (row[tagCol]) {
                        tags[tagCol] = row[tagCol];
                    }
                });

                // Determine device profile ID (from fix select, step 3 select, or CSV column)
                let deviceProfileId = '';
                const fixSelect = document.getElementById('fixDeviceProfileSelect');
                if (retryMode && fixSelect.value) {
                    deviceProfileId = fixSelect.value;
                } else {
                    const selectedDP = getSelectedDeviceProfile();
                    deviceProfileId = selectedDP.id;
                    if (!deviceProfileId && mapping.device_profile_id) {
                        deviceProfileId = row[mapping.device_profile_id];
                    }
                }

                // Device payload
                const devicePayload = {
                    device: {
                        application_id: selectedApplicationId,
                        name: deviceName,
                        description: mapping.description ? row[mapping.description] : '',
                        dev_eui: devEui,
                        device_profile_id: deviceProfileId || '',
                        tags: tags
                    }
                };

                try {
                    // Create device
                    await apiCall('/api/devices', 'POST', devicePayload);
                    log(`âœ“ Device ${deviceName} crÃ©Ã©`, 'success');

                    // Add keys if app_key is mapped
                    if (mapping.app_key && row[mapping.app_key]) {
                        const keysPayload = {
                            device_keys: {
                                dev_eui: devEui,
                                nwk_key: row[mapping.app_key]
                            }
                        };

                        try {
                            await apiCall(`/api/devices/${devEui}/keys`, 'POST', keysPayload);
                            log(`  â†³ ClÃ©s ajoutÃ©es`, 'info');
                        } catch (keyErr) {
                            log(`  âš  ClÃ©s non ajoutÃ©es: ${keyErr.message}`, 'error');
                        }
                    }

                    success++;
                } catch (err) {
                    const friendlyError = parseApiError(err.message);
                    log(`âœ— ${deviceName}: ${friendlyError}`, 'error');
                    errors++;

                    // Track Device Profile errors for retry
                    if (err.message.includes('invalid length') && err.message.includes('found 0')) {
                        hasDeviceProfileError = true;
                        failedRows.push(row);
                    }
                }

                document.getElementById('statSuccess').textContent = success;
                document.getElementById('statError').textContent = errors;
            }

            document.getElementById('importBtn').disabled = false;
            log(`\nâ•â•â• Import terminÃ©: ${success}/${total} devices crÃ©Ã©s â•â•â•`, success === total ? 'success' : 'info');

            // Show fix section if Device Profile errors occurred
            if (hasDeviceProfileError && failedRows.length > 0) {
                const fixSection = document.getElementById('fixDeviceProfileSection');
                const fixSelect = document.getElementById('fixDeviceProfileSelect');

                // Populate the fix select with device profiles
                fixSelect.innerHTML = '<option value="">-- SÃ©lectionnez un Device Profile --</option>' +
                    deviceProfiles.map(dp => `<option value="${dp.id}">${dp.name}</option>`).join('');

                fixSection.classList.remove('hidden');
            }
        }

        function retryWithDeviceProfile() {
            const fixSelect = document.getElementById('fixDeviceProfileSelect');
            if (!fixSelect.value) {
                alert('Veuillez sÃ©lectionner un Device Profile');
                return;
            }
            hasDeviceProfileError = false;
            startImport(true); // Retry mode
        }

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function parseApiError(errorMessage) {
            // Parse ChirpStack error messages to make them user-friendly
            if (errorMessage.includes('invalid length: expected length 32') && errorMessage.includes('found 0')) {
                return 'Device Profile ID manquant. SÃ©lectionnez un Device Profile ou mappez la colonne dans le CSV.';
            }
            if (errorMessage.includes('invalid length: expected length 32')) {
                return 'Un champ UUID est invalide (doit faire 32 caractÃ¨res). VÃ©rifiez device_profile_id ou application_id.';
            }
            if (errorMessage.includes('object already exists')) {
                return 'Ce device existe dÃ©jÃ  (dev_eui en doublon).';
            }
            if (errorMessage.includes('invalid DevEUI')) {
                return 'DevEUI invalide. Doit Ãªtre 16 caractÃ¨res hexadÃ©cimaux.';
            }
            if (errorMessage.includes('invalid AppKey') || errorMessage.includes('invalid NwkKey')) {
                return 'AppKey/NwkKey invalide. Doit Ãªtre 32 caractÃ¨res hexadÃ©cimaux.';
            }

            // Try to extract just the message from JSON
            try {
                const parsed = JSON.parse(errorMessage.substring(errorMessage.indexOf('{')));
                if (parsed.message) {
                    return parsed.message || errorMessage;
                }
            } catch (e) {}

            return errorMessage;
        }

        function resetAll() {
            csvData = [];
            csvHeaders = [];
            manualTags = {};
            csvTags = [];
            requiredTagValues = {};
            currentFile = null;
            currentFileType = null;
            detectedSeparator = null;

            document.getElementById('fileName').textContent = '';
            fileInput.value = '';
            mappingSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            actionsSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            document.getElementById('manualTagContainer').innerHTML = '';

            // Reset separator section
            document.getElementById('separatorSection').style.display = 'block';
            document.getElementById('detectedSeparator').style.display = 'none';
            document.querySelector('input[name="separator"][value="auto"]').checked = true;

            // Reset profile selection
            document.getElementById('importProfileSelect').value = '';
            selectedProfile = null;
            requiredTagValues = {};
            document.getElementById('requiredTagsSection').classList.add('hidden');
            document.getElementById('requiredTagsError').classList.add('hidden');
            document.getElementById('profileSummary').classList.add('hidden');

            // Reset file upload card to disabled state
            const fileUploadCard = document.getElementById('fileUploadCard');
            fileUploadCard.style.opacity = '0.5';
            fileUploadCard.style.pointerEvents = 'none';
            document.getElementById('profileSelectionHint').style.display = 'block';
        }

        // Listen for separator changes
        document.querySelectorAll('input[name="separator"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const detectedSeparatorEl = document.getElementById('detectedSeparator');

                if (radio.value === 'auto') {
                    // Re-detect separator
                    if (currentFile && currentFileType === 'csv') {
                        handleFile(currentFile);
                    }
                } else {
                    // Manual selection - hide detected separator message
                    detectedSeparatorEl.style.display = 'none';
                    if (currentFile && currentFileType === 'csv') {
                        // Re-parse with manual separator
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            parseCSV(e.target.result);
                        };
                        reader.readAsText(currentFile);
                    }
                }
            });
        });

        // ==================== TENANT DASHBOARD ====================
        async function loadTenantDashboard(tenantId) {
            const dashboard = document.getElementById('tenantDashboard');
            dashboard.classList.remove('hidden');
            dashboard.classList.add('loading');

            // Reset values
            document.getElementById('dashActiveDevices').textContent = '-';
            document.getElementById('dashInactiveDevices').textContent = '-';
            document.getElementById('dashNeverSeenDevices').textContent = '-';
            document.getElementById('dashActiveGateways').textContent = '-';

            try {
                // First, fetch all applications for this tenant
                const appsData = await apiCall(`/api/applications?tenant_id=${tenantId}&limit=100`);
                const apps = appsData.result || [];

                // Fetch devices from all applications
                let allDevices = [];
                for (const app of apps) {
                    try {
                        const devicesData = await apiCall(`/api/devices?application_id=${app.id}&limit=1000`);
                        const devices = devicesData.result || [];
                        allDevices = allDevices.concat(devices);
                    } catch (e) {
                        console.warn(`Could not fetch devices for app ${app.id}:`, e);
                    }
                }

                // Fetch all gateways for this tenant
                const gatewaysData = await apiCall(`/api/gateways?tenant_id=${tenantId}&limit=100`);
                const gateways = gatewaysData.result || [];

                // Calculate device stats based on lastSeenAt (24h threshold like ChirpStack)
                const now = new Date();
                let activeCount = 0;
                let inactiveCount = 0;
                let neverSeenCount = 0;

                allDevices.forEach(device => {
                    if (!device.lastSeenAt) {
                        neverSeenCount++;
                    } else {
                        const lastSeen = new Date(device.lastSeenAt);
                        const diffHours = (now - lastSeen) / (1000 * 60 * 60);
                        if (diffHours <= 24) {
                            activeCount++;
                        } else {
                            inactiveCount++;
                        }
                    }
                });

                console.log(`Dashboard - Total: ${allDevices.length}, Active: ${activeCount}, Inactive: ${inactiveCount}, Never seen: ${neverSeenCount}`);

                // Calculate active gateways using state field (ONLINE/OFFLINE)
                let activeGateways = 0;
                gateways.forEach(gw => {
                    // ChirpStack v4 uses 'state' field: "ONLINE" or "OFFLINE" or "NEVER_SEEN"
                    if (gw.state === 'ONLINE') {
                        activeGateways++;
                    }
                });

                console.log(`Dashboard - Devices: active=${activeCount}, inactive=${inactiveCount}, neverSeen=${neverSeenCount}`);
                console.log(`Dashboard - Gateways: active=${activeGateways}/${gateways.length}`);

                // Update UI
                document.getElementById('dashActiveDevices').textContent = activeCount;
                document.getElementById('dashInactiveDevices').textContent = inactiveCount;
                document.getElementById('dashNeverSeenDevices').textContent = neverSeenCount;
                document.getElementById('dashActiveGateways').textContent = `${activeGateways}/${gateways.length}`;

                dashboard.classList.remove('loading');

            } catch (err) {
                console.error('Dashboard error:', err);
                dashboard.classList.remove('loading');
                // Keep showing dashboard with placeholder values
                document.getElementById('dashActiveDevices').textContent = '?';
                document.getElementById('dashInactiveDevices').textContent = '?';
                document.getElementById('dashNeverSeenDevices').textContent = '?';
                document.getElementById('dashActiveGateways').textContent = '?';
            }
        }

        function hideTenantDashboard() {
            document.getElementById('tenantDashboard').classList.add('hidden');
        }

        function onTenantSelected() {
            const tenantId = document.getElementById('tenantSelect').value;
            if (tenantId) {
                loadTenantDashboard(tenantId);
            } else {
                hideTenantDashboard();
            }
        }

        // ==================== SAVED SERVERS ====================
        let savedServers = [];

        async function loadSavedServers() {
            try {
                const response = await fetch('/api/servers');
                const data = await response.json();
                savedServers = data.servers || [];
                renderServerDropdown();
            } catch (err) {
                console.error('Failed to load servers:', err);
            }
        }

        function renderServerDropdown() {
            const container = document.getElementById('serverDropdownList');
            if (savedServers.length === 0) {
                container.innerHTML = '<div class="server-dropdown-empty">Aucun serveur sauvegardÃ©</div>';
                return;
            }

            container.innerHTML = savedServers.map((server, index) => `
                <div class="server-dropdown-item" data-server-index="${index}">
                    <div class="server-dropdown-item-info">
                        <div class="server-dropdown-item-name">${escapeHtml(server.name)}</div>
                        <div class="server-dropdown-item-url">${escapeHtml(server.url)}</div>
                    </div>
                    <button class="server-dropdown-item-delete" data-server-id="${server.id}" title="Supprimer">âœ•</button>
                </div>
            `).join('');
        }

        // Event delegation for server dropdown - initialize after DOM ready
        function initServerDropdownEvents() {
            const dropdownList = document.getElementById('serverDropdownList');
            if (dropdownList) {
                dropdownList.addEventListener('click', function(e) {
                    console.log('Click in dropdown list', e.target);

                    const deleteBtn = e.target.closest('.server-dropdown-item-delete');
                    if (deleteBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const serverId = deleteBtn.dataset.serverId;
                        console.log('Delete server:', serverId);
                        deleteServer(serverId);
                        return;
                    }

                    const item = e.target.closest('.server-dropdown-item');
                    if (item) {
                        e.preventDefault();
                        e.stopPropagation();
                        const index = parseInt(item.dataset.serverIndex);
                        console.log('Select server index:', index, savedServers[index]);
                        if (!isNaN(index) && savedServers[index]) {
                            selectServer(savedServers[index].url);
                        }
                    }
                });
                console.log('Server dropdown events initialized');
            }
        }

        function toggleServerDropdown() {
            const dropdown = document.getElementById('serverDropdown');
            dropdown.classList.toggle('hidden');

            // Close on click outside
            if (!dropdown.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeServerDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeServerDropdownOnClickOutside(e) {
            const dropdown = document.getElementById('serverDropdown');
            const wrapper = document.querySelector('.server-input-wrapper');
            const selectBtn = document.querySelector('.server-select-btn');

            // Don't close if clicking inside dropdown or on the toggle button
            if (wrapper.contains(e.target)) {
                return;
            }

            dropdown.classList.add('hidden');
            document.removeEventListener('click', closeServerDropdownOnClickOutside);
        }

        function selectServer(url) {
            console.log('Selecting server:', url);
            document.getElementById('apiUrl').value = url;
            document.getElementById('serverDropdown').classList.add('hidden');
            document.removeEventListener('click', closeServerDropdownOnClickOutside);
        }

        function openSaveServerModal() {
            const currentUrl = document.getElementById('apiUrl').value.trim();

            document.getElementById('serverUrlInput').value = currentUrl;
            document.getElementById('serverName').value = '';
            document.getElementById('saveServerBackdrop').classList.remove('hidden');
            document.getElementById('saveServerModal').classList.remove('hidden');
            document.getElementById('serverName').focus();
        }

        function closeSaveServerModal() {
            document.getElementById('saveServerBackdrop').classList.add('hidden');
            document.getElementById('saveServerModal').classList.add('hidden');
        }

        async function saveServer() {
            const name = document.getElementById('serverName').value.trim();
            const url = document.getElementById('serverUrlInput').value.trim();

            if (!url) {
                alert('Veuillez entrer l\'URL du serveur');
                return;
            }

            if (!name) {
                alert('Veuillez entrer un nom pour identifier le serveur');
                return;
            }

            // Check if URL already exists
            if (savedServers.some(s => s.url === url)) {
                alert('Ce serveur est dÃ©jÃ  sauvegardÃ©');
                return;
            }

            try {
                const response = await fetch('/api/servers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, url })
                });

                if (!response.ok) {
                    const err = await response.json();
                    alert(err.error || 'Erreur lors de la sauvegarde');
                    return;
                }

                closeSaveServerModal();
                await loadSavedServers();
            } catch (err) {
                console.error('Save server error:', err);
                alert('Erreur lors de la sauvegarde');
            }
        }

        async function deleteServer(serverId) {
            if (!confirm('Supprimer ce serveur ?')) return;

            try {
                await fetch(`/api/servers/${serverId}`, { method: 'DELETE' });
                await loadSavedServers();
            } catch (err) {
                console.error('Delete server error:', err);
            }
        }

        // Load saved servers on page load
        loadSavedServers();
        initServerDropdownEvents();

        // ==================== PROFILES ====================
        async function loadProfiles() {
            try {
                const response = await fetch('/api/profiles');
                const data = await response.json();
                profiles = data.profiles || [];
                renderProfileList();
                renderProfileSelect();
            } catch (err) {
                console.error('Failed to load profiles:', err);
            }
        }

        function renderProfileList() {
            const container = document.getElementById('profileList');
            if (profiles.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); font-size: 0.9rem;">Aucun profil enregistre</p>';
                return;
            }

            container.innerHTML = profiles.map(p => `
                <div class="profile-item">
                    <div class="profile-item-info">
                        <div class="profile-item-name">${escapeHtml(p.name)}</div>
                        <div class="profile-item-tags">${p.requiredTags.length} tag(s): ${p.requiredTags.map(t => escapeHtml(t)).join(', ') || '-'}</div>
                    </div>
                    <div class="profile-item-actions">
                        <button onclick="editProfile('${p.id}')" title="Modifier">&#9998;</button>
                        <button class="delete" onclick="deleteProfile('${p.id}')" title="Supprimer">&#128465;</button>
                    </div>
                </div>
            `).join('');
        }

        function renderProfileSelect() {
            const select = document.getElementById('importProfileSelect');
            const currentValue = select.value; // Preserve current selection
            select.innerHTML = '<option value="">-- SÃ©lectionnez un profil --</option>' +
                '<option value="__none__">Sans profil (import simple)</option>' +
                profiles.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (${p.requiredTags.length} tags)</option>`).join('');
            // Restore selection if it still exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openProfileModal() {
            document.getElementById('profileModal').classList.remove('hidden');
            loadProfiles();
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
            resetProfileForm();
        }

        function focusTagInput() {
            document.getElementById('newTagInput').focus();
        }

        function handleTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('newTagInput');
                const tag = input.value.trim();
                if (tag && !profileFormTags.includes(tag)) {
                    profileFormTags.push(tag);
                    renderFormTags();
                }
                input.value = '';
            }
        }

        function renderFormTags() {
            const container = document.getElementById('tagInputContainer');
            const input = document.getElementById('newTagInput');

            // Remove existing tag chips
            container.querySelectorAll('.tag-chip').forEach(el => el.remove());

            // Add tag chips before the input
            profileFormTags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.innerHTML = `${escapeHtml(tag)} <button onclick="removeFormTag('${escapeHtml(tag)}')">&times;</button>`;
                container.insertBefore(chip, input);
            });
        }

        function removeFormTag(tag) {
            profileFormTags = profileFormTags.filter(t => t !== tag);
            renderFormTags();
        }

        function resetProfileForm() {
            document.getElementById('profileName').value = '';
            document.getElementById('editingProfileId').value = '';
            document.getElementById('profileFormTitle').textContent = 'Nouveau profil';
            document.getElementById('saveProfileBtn').textContent = 'Creer le profil';
            profileFormTags = [];
            renderFormTags();
        }

        function editProfile(id) {
            const profile = profiles.find(p => p.id === id);
            if (!profile) return;

            document.getElementById('profileName').value = profile.name;
            document.getElementById('editingProfileId').value = profile.id;
            document.getElementById('profileFormTitle').textContent = 'Modifier le profil';
            document.getElementById('saveProfileBtn').textContent = 'Enregistrer';
            profileFormTags = [...profile.requiredTags];
            renderFormTags();
        }

        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const editingId = document.getElementById('editingProfileId').value;

            if (!name) {
                alert('Veuillez entrer un nom de profil');
                return;
            }

            const profileData = {
                name: name,
                requiredTags: profileFormTags
            };

            try {
                let response;
                if (editingId) {
                    // Update existing profile
                    response = await fetch(`/api/profiles/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profileData)
                    });
                } else {
                    // Create new profile
                    response = await fetch('/api/profiles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(profileData)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erreur serveur');
                }

                resetProfileForm();
                await loadProfiles();
            } catch (err) {
                console.error('Save profile error:', err);
                alert('Erreur lors de la sauvegarde: ' + err.message);
            }
        }

        async function deleteProfile(id) {
            if (!confirm('Supprimer ce profil ?')) return;

            try {
                await fetch(`/api/profiles/${id}`, { method: 'DELETE' });
                loadProfiles();

                // Reset selection if this profile was selected
                if (selectedProfile && selectedProfile.id === id) {
                    document.getElementById('importProfileSelect').value = '';
                    onProfileSelected(); // This will reset selectedProfile and disable file upload
                }
            } catch (err) {
                alert('Erreur lors de la suppression: ' + err.message);
            }
        }

        function onProfileSelected() {
            const select = document.getElementById('importProfileSelect');
            const profileId = select.value;
            const fileUploadCard = document.getElementById('fileUploadCard');
            const profileHint = document.getElementById('profileSelectionHint');
            const profileSummary = document.getElementById('profileSummary');

            // Reset required tags section (will be populated when file is loaded)
            document.getElementById('requiredTagsSection').classList.add('hidden');
            document.getElementById('requiredTagsError').classList.add('hidden');
            requiredTagValues = {};

            // No selection - disable file upload
            if (!profileId) {
                selectedProfile = null;
                fileUploadCard.style.opacity = '0.5';
                fileUploadCard.style.pointerEvents = 'none';
                profileHint.style.display = 'block';
                profileSummary.classList.add('hidden');
                return;
            }

            // Profile selected (or "Sans profil") - enable file upload
            fileUploadCard.style.opacity = '1';
            fileUploadCard.style.pointerEvents = 'auto';
            profileHint.style.display = 'none';

            // Handle "Sans profil" option
            if (profileId === '__none__') {
                selectedProfile = null;
                profileSummary.textContent = 'Import simple sans tags obligatoires';
                profileSummary.classList.remove('hidden');
                // Update required tags section if file already loaded
                if (csvData.length > 0) {
                    populateRequiredTagsSection();
                }
                return;
            }

            // Regular profile selected
            selectedProfile = profiles.find(p => p.id === profileId);
            if (selectedProfile) {
                const tagCount = selectedProfile.requiredTags.length;
                if (tagCount > 0) {
                    profileSummary.innerHTML = `Profil <strong style="color: var(--accent);">${escapeHtml(selectedProfile.name)}</strong> â€” ${tagCount} tag(s) obligatoire(s) : <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent);">${selectedProfile.requiredTags.join(', ')}</span>`;
                } else {
                    profileSummary.innerHTML = `Profil <strong style="color: var(--accent);">${escapeHtml(selectedProfile.name)}</strong> â€” aucun tag obligatoire`;
                }
                profileSummary.classList.remove('hidden');

                // Update required tags section if file already loaded
                if (csvData.length > 0) {
                    populateRequiredTagsSection();
                }
            } else {
                profileSummary.classList.add('hidden');
            }
        }

        function populateRequiredTagsSection() {
            const section = document.getElementById('requiredTagsSection');
            const inputsContainer = document.getElementById('requiredTagsInputs');
            const errorDiv = document.getElementById('requiredTagsError');

            // Hide if no profile or no required tags
            if (!selectedProfile || selectedProfile.requiredTags.length === 0) {
                section.classList.add('hidden');
                return;
            }

            // Build inputs for each required tag
            document.getElementById('requiredTagsTitle').textContent = `Tags obligatoires â€” ${selectedProfile.name}`;

            inputsContainer.innerHTML = selectedProfile.requiredTags.map(tag => `
                <div class="required-tag-input">
                    <label>${escapeHtml(tag)}</label>
                    <input type="text" id="reqTag_manual_${escapeHtml(tag)}" placeholder="Valeur fixe pour tous" oninput="updateRequiredTagValue('${escapeHtml(tag)}', 'manual', this.value)">
                    <span class="input-or">ou</span>
                    <select id="reqTag_csv_${escapeHtml(tag)}" onchange="updateRequiredTagValue('${escapeHtml(tag)}', 'csv', this.value)">
                        <option value="">-- Colonne du fichier --</option>
                        ${csvHeaders.map(h => `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`).join('')}
                    </select>
                </div>
            `).join('');

            section.classList.remove('hidden');
            errorDiv.classList.add('hidden');
        }

        function updateRequiredTagValue(tag, type, value) {
            if (type === 'manual' && value) {
                // Clear CSV selection when manual value is entered
                document.getElementById(`reqTag_csv_${tag}`).value = '';
                requiredTagValues[tag] = { type: 'manual', value: value };
            } else if (type === 'csv' && value) {
                // Clear manual input when CSV column is selected
                document.getElementById(`reqTag_manual_${tag}`).value = '';
                requiredTagValues[tag] = { type: 'csv', column: value };
            } else if (!value) {
                // If value is cleared, remove from required tag values
                delete requiredTagValues[tag];
            }
            // Update preview to show current tag values
            if (csvData.length > 0) {
                updatePreview();
            }
        }

        function validateRequiredTags() {
            if (!selectedProfile || selectedProfile.requiredTags.length === 0) {
                return true;
            }

            const missingTags = [];
            for (const tag of selectedProfile.requiredTags) {
                const tagValue = requiredTagValues[tag];
                if (!tagValue || (!tagValue.value && !tagValue.column)) {
                    missingTags.push(tag);
                }
            }

            if (missingTags.length > 0) {
                const errorDiv = document.getElementById('requiredTagsError');
                errorDiv.innerHTML = `&#9888; Tags obligatoires manquants: ${missingTags.join(', ')}`;
                errorDiv.classList.remove('hidden');
                return false;
            }

            document.getElementById('requiredTagsError').classList.add('hidden');
            return true;
        }

        function getRequiredTagsForRow(row) {
            if (!selectedProfile) return {};

            const tags = {};
            for (const tag of selectedProfile.requiredTags) {
                const tagConfig = requiredTagValues[tag];
                if (tagConfig) {
                    if (tagConfig.type === 'manual') {
                        tags[tag] = tagConfig.value;
                    } else if (tagConfig.type === 'csv' && tagConfig.column) {
                        tags[tag] = row[tagConfig.column] || '';
                    }
                }
            }
            return tags;
        }

        // ==================== MANUAL MODE ====================
        let currentImportMode = 'file';
        let manualDevices = [];
        const MAX_MANUAL_DEVICES = 5;

        function setImportMode(mode) {
            currentImportMode = mode;

            // Update toggle buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Show/hide appropriate containers
            const fileUploadCard = document.getElementById('fileUploadCard');
            const manualContainer = document.getElementById('manualEntryContainer');
            const mappingSection = document.getElementById('mappingSection');

            if (mode === 'file') {
                fileUploadCard.classList.remove('hidden');
                manualContainer.classList.add('hidden');
                // Re-enable file upload if profile is selected
                if (selectedProfile || document.getElementById('importProfileSelect').value === '__none__') {
                    fileUploadCard.style.opacity = '1';
                    fileUploadCard.style.pointerEvents = 'auto';
                }
            } else {
                fileUploadCard.classList.add('hidden');
                mappingSection.classList.add('hidden');
                manualContainer.classList.remove('hidden');
                // Initialize with one device if empty
                if (manualDevices.length === 0) {
                    addManualDevice();
                }
            }
        }

        function addManualDevice() {
            if (manualDevices.length >= MAX_MANUAL_DEVICES) return;

            const deviceId = Date.now();
            manualDevices.push({ id: deviceId });
            renderManualDevices();
            updateDeviceCounter();
            updateImportManualBtn();
        }

        function removeManualDevice(deviceId) {
            manualDevices = manualDevices.filter(d => d.id !== deviceId);
            renderManualDevices();
            updateDeviceCounter();
            updateImportManualBtn();
        }

        function renderManualDevices() {
            const container = document.getElementById('manualDevicesList');
            const requiredTags = selectedProfile ? selectedProfile.requiredTags : [];

            container.innerHTML = manualDevices.map((device, index) => `
                <div class="manual-device-card" data-device-id="${device.id}">
                    <div class="manual-device-header">
                        <h4><span>${index + 1}</span> Device</h4>
                        ${manualDevices.length > 1 ? `
                            <button class="remove-device-btn" onclick="removeManualDevice(${device.id})" title="Supprimer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                    <div class="manual-device-fields">
                        <div>
                            <label>DevEUI <span style="color: var(--error);">*</span></label>
                            <input type="text"
                                   class="manual-deveui"
                                   placeholder="70B3D52DD3000001"
                                   maxlength="16"
                                   oninput="this.value = this.value.toUpperCase().replace(/[^0-9A-F]/g, ''); updateImportManualBtn();">
                        </div>
                        <div>
                            <label>Nom</label>
                            <input type="text"
                                   class="manual-name"
                                   placeholder="Capteur-${index + 1}">
                        </div>
                        <div class="field-full">
                            <label>AppKey (optionnel)</label>
                            <input type="text"
                                   class="manual-appkey"
                                   placeholder="2B7E151628AED2A6ABF7158809CF4F3C"
                                   maxlength="32"
                                   oninput="this.value = this.value.toUpperCase().replace(/[^0-9A-F]/g, '');">
                        </div>
                    </div>
                    ${requiredTags.length > 0 ? `
                        <div class="manual-device-tags">
                            <h5>Tags obligatoires (${selectedProfile.name})</h5>
                            <div class="manual-tags-grid">
                                ${requiredTags.map(tag => `
                                    <div class="manual-tag-field">
                                        <label>${escapeHtml(tag)} <span style="color: var(--error);">*</span></label>
                                        <input type="text"
                                               class="manual-tag"
                                               data-tag="${escapeHtml(tag)}"
                                               placeholder="${escapeHtml(tag)}"
                                               oninput="updateImportManualBtn();">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // Update add button state
            document.getElementById('addDeviceBtn').disabled = manualDevices.length >= MAX_MANUAL_DEVICES;
        }

        function updateDeviceCounter() {
            document.getElementById('deviceCount').textContent = manualDevices.length;
        }

        function updateImportManualBtn() {
            const btn = document.getElementById('importManualBtn');
            const isValid = validateManualDevices(false);
            btn.disabled = !isValid;
        }

        function validateManualDevices(showErrors = true) {
            const cards = document.querySelectorAll('.manual-device-card');
            let isValid = true;
            const requiredTags = selectedProfile ? selectedProfile.requiredTags : [];

            if (cards.length === 0) return false;

            cards.forEach(card => {
                const deveuiInput = card.querySelector('.manual-deveui');
                const deveui = deveuiInput.value.trim();

                // Check DevEUI
                if (!deveui || deveui.length !== 16) {
                    isValid = false;
                    if (showErrors) {
                        deveuiInput.style.borderColor = 'var(--error)';
                    }
                } else {
                    deveuiInput.style.borderColor = '';
                }

                // Check required tags
                requiredTags.forEach(tag => {
                    const tagInput = card.querySelector(`.manual-tag[data-tag="${tag}"]`);
                    if (tagInput) {
                        const value = tagInput.value.trim();
                        if (!value) {
                            isValid = false;
                            if (showErrors) {
                                tagInput.style.borderColor = 'var(--error)';
                            }
                        } else {
                            tagInput.style.borderColor = '';
                        }
                    }
                });
            });

            return isValid;
        }

        function clearManualDevices() {
            if (manualDevices.length === 0) return;
            if (!confirm('Effacer tous les devices ?')) return;

            manualDevices = [];
            renderManualDevices();
            updateDeviceCounter();
            addManualDevice(); // Add one empty device
        }

        async function importManualDevices() {
            if (!validateManualDevices(true)) {
                alert('Veuillez remplir tous les champs obligatoires (DevEUI + tags du profil)');
                return;
            }

            const cards = document.querySelectorAll('.manual-device-card');
            const devices = [];
            const requiredTags = selectedProfile ? selectedProfile.requiredTags : [];

            cards.forEach(card => {
                const deveui = card.querySelector('.manual-deveui').value.trim();
                const name = card.querySelector('.manual-name').value.trim() || deveui;
                const appkey = card.querySelector('.manual-appkey').value.trim();

                const tags = {};
                requiredTags.forEach(tag => {
                    const tagInput = card.querySelector(`.manual-tag[data-tag="${tag}"]`);
                    if (tagInput) {
                        tags[tag] = tagInput.value.trim();
                    }
                });

                devices.push({ deveui, name, appkey, tags });
            });

            // Get device profile
            const selectedDP = getSelectedDeviceProfile();
            if (!selectedDP || !selectedDP.id) {
                alert('Veuillez sÃ©lectionner un Device Profile');
                return;
            }

            // Show results section
            document.getElementById('mappingSection').classList.add('hidden');
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.remove('hidden');

            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';

            let successCount = 0;
            let errorCount = 0;

            log(`DÃ©but de l'import manuel de ${devices.length} device(s)...`, 'info');
            log(`Application: ${document.getElementById('summaryApp').textContent}`, 'info');
            log(`Device Profile: ${selectedDP.name}`, 'info');
            log('â”€'.repeat(40), 'info');

            for (const device of devices) {
                try {
                    // Create device
                    const devicePayload = {
                        device: {
                            dev_eui: device.deveui,
                            name: device.name,
                            description: '',
                            application_id: selectedApplicationId,
                            device_profile_id: selectedDP.id,
                            is_disabled: false,
                            tags: device.tags
                        }
                    };

                    await apiCall('/api/devices', 'POST', devicePayload);

                    // Add keys if appkey provided
                    if (device.appkey) {
                        const keysPayload = {
                            device_keys: {
                                dev_eui: device.deveui,
                                nwk_key: device.appkey,
                                app_key: device.appkey
                            }
                        };
                        await apiCall(`/api/devices/${device.deveui}/keys`, 'POST', keysPayload);
                    }

                    log(`âœ“ ${device.name} (${device.deveui})`, 'success');
                    successCount++;

                } catch (error) {
                    const errorMsg = parseApiError(error.message || String(error));
                    log(`âœ— ${device.name} (${device.deveui}): ${errorMsg}`, 'error');
                    errorCount++;
                }
            }

            log('â”€'.repeat(40), 'info');
            log(`Import terminÃ©: ${successCount} succÃ¨s, ${errorCount} erreur(s)`, successCount > 0 && errorCount === 0 ? 'success' : 'info');

            // Update stats
            document.getElementById('statSuccess').textContent = successCount;
            document.getElementById('statError').textContent = errorCount;
            document.getElementById('statTotal').textContent = devices.length;

            // Clear manual devices on full success
            if (errorCount === 0 && successCount > 0) {
                manualDevices = [];
                renderManualDevices();
                updateDeviceCounter();
                addManualDevice();
            }
        }

        // Update onProfileSelected to enable/disable mode toggle
        const originalOnProfileSelected = onProfileSelected;
        onProfileSelected = function() {
            originalOnProfileSelected();

            const toggle = document.getElementById('importModeToggle');
            const profileId = document.getElementById('importProfileSelect').value;

            if (profileId) {
                toggle.classList.remove('disabled');
            } else {
                toggle.classList.add('disabled');
            }

            // Re-render manual devices if in manual mode (to update tags)
            if (currentImportMode === 'manual') {
                renderManualDevices();
                updateImportManualBtn();
            }
        };

        // ==================== TOOLS HUB NAVIGATION ====================
        function showTool(toolName) {
            document.getElementById('toolsHub').classList.add('hidden');
            // Hide all subviews
            document.querySelectorAll('#step3 > .tool-subview').forEach(el => el.classList.add('hidden'));
            // Show the target
            const viewId = toolName + 'SubView';
            const view = document.getElementById(viewId);
            if (view) view.classList.remove('hidden');
        }

        function backToToolsHub() {
            document.querySelectorAll('#step3 > .tool-subview').forEach(el => el.classList.add('hidden'));
            document.getElementById('toolsHub').classList.remove('hidden');
        }

        // ==================== SHARED UTILITIES ====================
        async function loadAllDevicesFromApp(applicationId, progressCallback) {
            let allDevices = [];
            let offset = 0;
            const limit = 100;
            let total = 0;

            do {
                const data = await apiCall(`/api/devices?applicationId=${applicationId}&limit=${limit}&offset=${offset}`);
                const devices = data.result || [];
                total = parseInt(data.totalCount) || 0;
                allDevices = allDevices.concat(devices);
                offset += devices.length;
                if (progressCallback) progressCallback(allDevices.length, total);
                if (devices.length === 0) break;
            } while (allDevices.length < total);

            return allDevices;
        }

        function triggerDownload(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== TEMPLATE CSV (Phase 2) ====================
        function openTemplateModal() {
            // Populate device profile select
            const dpSelect = document.getElementById('templateDpSelect');
            dpSelect.innerHTML = '<option value="">-- Aucun (colonne device_profile_id incluse) --</option>' +
                deviceProfiles.map(dp => `<option value="${dp.id}">${dp.name}</option>`).join('');

            // Populate profile select
            const profSelect = document.getElementById('templateProfileSelect');
            profSelect.innerHTML = '<option value="">-- Aucun --</option>' +
                profiles.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (${p.requiredTags.length} tags)</option>`).join('');

            document.getElementById('templateModal').classList.remove('hidden');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.add('hidden');
        }

        function downloadCsvTemplate() {
            const dpId = document.getElementById('templateDpSelect').value;
            const profileId = document.getElementById('templateProfileSelect').value;

            // Base columns
            let columns = ['name', 'dev_eui', 'description', 'app_key'];
            if (!dpId) columns.push('device_profile_id');

            // Add profile required tags
            const selectedProf = profiles.find(p => p.id === profileId);
            if (selectedProf) {
                selectedProf.requiredTags.forEach(tag => {
                    if (!columns.includes(tag)) columns.push(tag);
                });
            }

            // Build CSV
            const header = columns.join(';');
            const example = columns.map(col => {
                switch(col) {
                    case 'name': return 'Capteur-001';
                    case 'dev_eui': return '70B3D52DD3000001';
                    case 'description': return 'Mon capteur';
                    case 'app_key': return '2B7E151628AED2A6ABF7158809CF4F3C';
                    case 'device_profile_id': return dpId || 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx';
                    default: return 'valeur_' + col;
                }
            }).join(';');

            const csv = header + '\n' + example + '\n';
            triggerDownload(csv, 'template_chirpstack.csv', 'text/csv;charset=utf-8;');
            closeTemplateModal();
        }

        // ==================== DUPLICATE DETECTION (Phase 3) ====================
        let existingDeviceEuis = new Set();
        let duplicatesFound = [];
        let importRowsAfterDuplicateCheck = [];
        let duplicateAction = null; // 'ignore' or 'overwrite'

        async function checkDuplicates() {
            const mapping = getMapping();
            if (!mapping.dev_eui) return false;

            // Load all existing devices
            log('Verification des doublons...', 'info');
            let allExisting;
            try {
                allExisting = await loadAllDevicesFromApp(selectedApplicationId, (loaded, total) => {
                    log(`  Chargement: ${loaded}/${total} devices existants`, 'info');
                });
            } catch (err) {
                log(`Impossible de verifier les doublons: ${err.message}`, 'error');
                return false; // Continue import without duplicate check
            }

            existingDeviceEuis = new Set(allExisting.map(d => d.devEui.toLowerCase()));

            // Find duplicates in CSV
            duplicatesFound = [];
            const existingMap = {};
            allExisting.forEach(d => { existingMap[d.devEui.toLowerCase()] = d; });

            csvData.forEach(row => {
                const devEui = (row[mapping.dev_eui] || '').toLowerCase();
                if (existingDeviceEuis.has(devEui)) {
                    duplicatesFound.push({
                        devEui: devEui,
                        existingName: existingMap[devEui] ? existingMap[devEui].name : '?',
                        csvName: row[mapping.name] || devEui,
                        row: row
                    });
                }
            });

            return duplicatesFound.length > 0;
        }

        function showDuplicateSection() {
            const section = document.getElementById('duplicateSection');
            const mapping = getMapping();
            document.getElementById('duplicateSummary').textContent =
                `${duplicatesFound.length} doublon(s) detecte(s) sur ${csvData.length} devices`;

            const tbody = document.querySelector('#duplicateTable tbody');
            tbody.innerHTML = duplicatesFound.map(d => `
                <tr>
                    <td>${d.devEui}</td>
                    <td>${escapeHtml(d.existingName)}</td>
                    <td>${escapeHtml(d.csvName)}</td>
                </tr>
            `).join('');

            section.classList.remove('hidden');
        }

        function cancelDuplicateImport() {
            document.getElementById('duplicateSection').classList.add('hidden');
            document.getElementById('importBtn').disabled = false;
        }

        function importIgnoringDuplicates() {
            document.getElementById('duplicateSection').classList.add('hidden');
            duplicateAction = 'ignore';
            executeImportWithDuplicateHandling();
        }

        function importOverwritingDuplicates() {
            document.getElementById('duplicateSection').classList.add('hidden');
            duplicateAction = 'overwrite';
            executeImportWithDuplicateHandling();
        }

        async function executeImportWithDuplicateHandling() {
            const mapping = getMapping();
            const duplicateEuis = new Set(duplicatesFound.map(d => d.devEui));

            resultsSection.classList.remove('hidden');
            document.getElementById('fixDeviceProfileSection').classList.add('hidden');
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            failedRows = [];
            hasDeviceProfileError = false;

            let success = 0;
            let errors = 0;
            let skipped = 0;
            const total = csvData.length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('importBtn').disabled = true;

            for (let i = 0; i < csvData.length; i++) {
                const row = csvData[i];
                const devEui = (row[mapping.dev_eui] || '').toLowerCase();
                const deviceName = row[mapping.name] || devEui;
                const isDuplicate = duplicateEuis.has(devEui);

                if (isDuplicate && duplicateAction === 'ignore') {
                    log(`âŠ˜ ${deviceName} (${devEui}): ignore (doublon)`, 'info');
                    skipped++;
                    continue;
                }

                if (isDuplicate && duplicateAction === 'overwrite') {
                    // Delete existing device first
                    try {
                        await apiCall(`/api/devices/${devEui}`, 'DELETE');
                        log(`  â†³ ${deviceName}: ancien device supprime`, 'info');
                    } catch (delErr) {
                        log(`  âš  ${deviceName}: echec suppression: ${delErr.message}`, 'error');
                        errors++;
                        document.getElementById('statError').textContent = errors;
                        continue;
                    }
                }

                // Build tags
                const profileTags = getRequiredTagsForRow(row);
                const tags = { ...profileTags, ...manualTags };
                csvTags.forEach(tagCol => {
                    if (row[tagCol]) tags[tagCol] = row[tagCol];
                });

                let deviceProfileId = '';
                const selectedDP = getSelectedDeviceProfile();
                deviceProfileId = selectedDP.id;
                if (!deviceProfileId && mapping.device_profile_id) {
                    deviceProfileId = row[mapping.device_profile_id];
                }

                const devicePayload = {
                    device: {
                        application_id: selectedApplicationId,
                        name: deviceName,
                        description: mapping.description ? row[mapping.description] : '',
                        dev_eui: devEui,
                        device_profile_id: deviceProfileId || '',
                        tags: tags
                    }
                };

                try {
                    await apiCall('/api/devices', 'POST', devicePayload);
                    log(`âœ“ Device ${deviceName} cree`, 'success');

                    if (mapping.app_key && row[mapping.app_key]) {
                        try {
                            await apiCall(`/api/devices/${devEui}/keys`, 'POST', {
                                device_keys: { dev_eui: devEui, nwk_key: row[mapping.app_key] }
                            });
                            log(`  â†³ Cles ajoutees`, 'info');
                        } catch (keyErr) {
                            log(`  âš  Cles non ajoutees: ${keyErr.message}`, 'error');
                        }
                    }
                    success++;
                } catch (err) {
                    const friendlyError = parseApiError(err.message);
                    log(`âœ— ${deviceName}: ${friendlyError}`, 'error');
                    errors++;
                    if (err.message.includes('invalid length') && err.message.includes('found 0')) {
                        hasDeviceProfileError = true;
                        failedRows.push(row);
                    }
                }

                document.getElementById('statSuccess').textContent = success;
                document.getElementById('statError').textContent = errors;
            }

            document.getElementById('importBtn').disabled = false;
            const summary = skipped > 0 ? `${success} crees, ${skipped} ignores, ${errors} erreurs` : `${success}/${total} devices crees`;
            log(`\nâ•â•â• Import termine: ${summary} â•â•â•`, success + skipped === total ? 'success' : 'info');

            if (hasDeviceProfileError && failedRows.length > 0) {
                const fixSection = document.getElementById('fixDeviceProfileSection');
                const fixSelect = document.getElementById('fixDeviceProfileSelect');
                fixSelect.innerHTML = '<option value="">-- Selectionnez un Device Profile --</option>' +
                    deviceProfiles.map(dp => `<option value="${dp.id}">${dp.name}</option>`).join('');
                fixSection.classList.remove('hidden');
            }
        }

        // ==================== EXPORT (Phase 4) ====================
        let exportDevices = [];
        let exportDeviceKeys = {};

        document.getElementById('exportIncludeKeys').addEventListener('change', function() {
            document.getElementById('exportKeysWarning').classList.toggle('hidden', !this.checked);
        });

        async function loadDevicesForExport() {
            const progress = document.getElementById('exportProgress');
            const progressBar = document.getElementById('exportProgressBar');
            const progressText = document.getElementById('exportProgressText');

            progress.classList.remove('hidden');
            document.getElementById('btnLoadExport').disabled = true;
            document.getElementById('exportAppName').textContent = selectedApplicationName;

            try {
                exportDevices = await loadAllDevicesFromApp(selectedApplicationId, (loaded, total) => {
                    const pct = total > 0 ? Math.round((loaded / total) * 100) : 0;
                    progressBar.style.width = pct + '%';
                    progressText.textContent = `Chargement: ${loaded}/${total} devices`;
                });

                // Fetch keys if checkbox is checked
                const includeKeys = document.getElementById('exportIncludeKeys').checked;
                exportDeviceKeys = {};
                if (includeKeys && exportDevices.length > 0) {
                    progressText.textContent = 'Recuperation des cles...';
                    for (let i = 0; i < exportDevices.length; i++) {
                        try {
                            const keysData = await apiCall(`/api/devices/${exportDevices[i].devEui}/keys`);
                            exportDeviceKeys[exportDevices[i].devEui] = keysData.deviceKeys || {};
                        } catch (e) {
                            // No keys for this device
                        }
                        const pct = Math.round(((i + 1) / exportDevices.length) * 100);
                        progressBar.style.width = pct + '%';
                        progressText.textContent = `Recuperation des cles: ${i + 1}/${exportDevices.length}`;
                    }
                }

                renderExportPreview();
                document.getElementById('exportPreviewCard').classList.remove('hidden');
                progressText.textContent = `${exportDevices.length} devices charges`;
            } catch (err) {
                progressText.textContent = `Erreur: ${err.message}`;
            }
            document.getElementById('btnLoadExport').disabled = false;
        }

        function renderExportPreview() {
            document.getElementById('exportDeviceCount').textContent = exportDevices.length;

            // Discover all tag keys
            const allTagKeys = new Set();
            exportDevices.forEach(d => {
                if (d.tags) Object.keys(d.tags).forEach(k => allTagKeys.add(k));
            });

            const includeKeys = document.getElementById('exportIncludeKeys').checked;
            let headers = ['dev_eui', 'name', 'description', 'device_profile_id', 'device_profile_name', 'created_at', 'last_seen_at'];
            const tagKeysArr = [...allTagKeys].sort();
            headers = headers.concat(tagKeysArr);
            if (includeKeys) headers.push('nwk_key', 'app_key');

            const thead = document.querySelector('#exportPreviewTable thead');
            const tbody = document.querySelector('#exportPreviewTable tbody');
            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            const preview = exportDevices.slice(0, 5);
            tbody.innerHTML = preview.map(d => {
                const keys = exportDeviceKeys[d.devEui] || {};
                const cells = [
                    d.devEui, d.name || '', d.description || '',
                    d.deviceProfileId || '', d.deviceProfileName || '',
                    d.createdAt || '', d.lastSeenAt || ''
                ];
                tagKeysArr.forEach(k => cells.push((d.tags && d.tags[k]) || ''));
                if (includeKeys) {
                    cells.push(keys.nwkKey || '', keys.appKey || '');
                }
                return `<tr>${cells.map(c => `<td>${escapeHtml(String(c))}</td>`).join('')}</tr>`;
            }).join('');
        }

        function downloadExport() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const includeKeys = document.getElementById('exportIncludeKeys').checked;

            const allTagKeys = new Set();
            exportDevices.forEach(d => {
                if (d.tags) Object.keys(d.tags).forEach(k => allTagKeys.add(k));
            });
            const tagKeysArr = [...allTagKeys].sort();

            let headers = ['dev_eui', 'name', 'description', 'device_profile_id', 'device_profile_name', 'created_at', 'last_seen_at'];
            headers = headers.concat(tagKeysArr);
            if (includeKeys) headers.push('nwk_key', 'app_key');

            const rows = exportDevices.map(d => {
                const keys = exportDeviceKeys[d.devEui] || {};
                const row = [
                    d.devEui, d.name || '', d.description || '',
                    d.deviceProfileId || '', d.deviceProfileName || '',
                    d.createdAt || '', d.lastSeenAt || ''
                ];
                tagKeysArr.forEach(k => row.push((d.tags && d.tags[k]) || ''));
                if (includeKeys) {
                    row.push(keys.nwkKey || '', keys.appKey || '');
                }
                return row;
            });

            if (format === 'xlsx') {
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Devices');
                XLSX.writeFile(wb, `export_${selectedApplicationName}_${new Date().toISOString().slice(0,10)}.xlsx`);
            } else {
                const csvContent = [headers.join(';')]
                    .concat(rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(';')))
                    .join('\n');
                triggerDownload(csvContent, `export_${selectedApplicationName}_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
            }
        }

        // ==================== BULK DELETE (Phase 5) ====================
        let deleteDevices = [];
        let deleteSelection = new Set();
        let deleteFilterQuery = '';

        async function loadDevicesForDelete() {
            const progress = document.getElementById('deleteProgress');
            const progressBar = document.getElementById('deleteProgressBar');
            const progressText = document.getElementById('deleteProgressText');

            progress.classList.remove('hidden');
            document.getElementById('btnLoadDelete').disabled = true;

            try {
                deleteDevices = await loadAllDevicesFromApp(selectedApplicationId, (loaded, total) => {
                    const pct = total > 0 ? Math.round((loaded / total) * 100) : 0;
                    progressBar.style.width = pct + '%';
                    progressText.textContent = `Chargement: ${loaded}/${total} devices`;
                });

                deleteSelection = new Set();
                deleteFilterQuery = '';
                renderDeleteList();
                document.getElementById('deleteListCard').classList.remove('hidden');
                progressText.textContent = `${deleteDevices.length} devices charges`;
            } catch (err) {
                progressText.textContent = `Erreur: ${err.message}`;
            }
            document.getElementById('btnLoadDelete').disabled = false;
        }

        function getFilteredDeleteDevices() {
            if (!deleteFilterQuery) return deleteDevices;
            const q = deleteFilterQuery.toLowerCase();
            return deleteDevices.filter(d =>
                (d.name && d.name.toLowerCase().includes(q)) ||
                (d.devEui && d.devEui.toLowerCase().includes(q))
            );
        }

        function renderDeleteList() {
            const filtered = getFilteredDeleteDevices();
            const tbody = document.querySelector('#deleteTable tbody');

            tbody.innerHTML = filtered.map(d => {
                const checked = deleteSelection.has(d.devEui) ? 'checked' : '';
                const profileName = d.deviceProfileName || '-';
                const lastSeen = d.lastSeenAt ? new Date(d.lastSeenAt).toLocaleString('fr-FR') : 'Jamais';
                return `<tr>
                    <td><input type="checkbox" class="device-checkbox" ${checked} onchange="toggleDeleteSelection('${d.devEui}')"></td>
                    <td>${escapeHtml(d.name || '-')}</td>
                    <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">${d.devEui}</td>
                    <td>${escapeHtml(profileName)}</td>
                    <td>${lastSeen}</td>
                </tr>`;
            }).join('');

            updateDeleteSelectionCount();
        }

        function toggleDeleteSelection(devEui) {
            if (deleteSelection.has(devEui)) {
                deleteSelection.delete(devEui);
            } else {
                deleteSelection.add(devEui);
            }
            updateDeleteSelectionCount();
        }

        function selectAllForDeletion() {
            const filtered = getFilteredDeleteDevices();
            filtered.forEach(d => deleteSelection.add(d.devEui));
            renderDeleteList();
        }

        function deselectAll() {
            deleteSelection.clear();
            renderDeleteList();
        }

        function filterDeleteList(query) {
            deleteFilterQuery = query;
            renderDeleteList();
        }

        function updateDeleteSelectionCount() {
            document.getElementById('deleteSelectionCount').textContent = deleteSelection.size;
            document.getElementById('btnBulkDelete').disabled = deleteSelection.size === 0;
        }

        function confirmBulkDelete() {
            if (deleteSelection.size === 0) return;
            document.getElementById('deleteConfirmCount').textContent = deleteSelection.size;
            document.getElementById('deleteConfirmNumber').textContent = deleteSelection.size;
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
        }

        async function executeBulkDelete() {
            const expectedCount = deleteSelection.size;
            const inputValue = document.getElementById('deleteConfirmInput').value.trim();

            if (inputValue !== String(expectedCount)) {
                alert('Le nombre saisi ne correspond pas');
                return;
            }

            closeDeleteConfirmModal();

            const resultsCard = document.getElementById('deleteResultsCard');
            const logContainer = document.getElementById('deleteLogContainer');
            const progressDiv = document.getElementById('deleteResultProgress');
            const progressBar = document.getElementById('deleteResultProgressBar');
            const progressText = document.getElementById('deleteResultProgressText');

            resultsCard.classList.remove('hidden');
            progressDiv.classList.remove('hidden');
            logContainer.innerHTML = '';

            const devEuis = [...deleteSelection];
            let success = 0;
            let errors = 0;

            for (let i = 0; i < devEuis.length; i++) {
                const devEui = devEuis[i];
                const device = deleteDevices.find(d => d.devEui === devEui);
                const name = device ? device.name : devEui;

                try {
                    await apiCall(`/api/devices/${devEui}`, 'DELETE');
                    const entry = document.createElement('div');
                    entry.className = 'log-entry log-success';
                    entry.textContent = `âœ“ ${name} (${devEui}) supprime`;
                    logContainer.appendChild(entry);
                    success++;
                } catch (err) {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry log-error';
                    entry.textContent = `âœ— ${name} (${devEui}): ${err.message}`;
                    logContainer.appendChild(entry);
                    errors++;
                }

                const pct = Math.round(((i + 1) / devEuis.length) * 100);
                progressBar.style.width = pct + '%';
                progressText.textContent = `Suppression: ${i + 1}/${devEuis.length}`;
                logContainer.scrollTop = logContainer.scrollHeight;

                // Small delay to not overwhelm API
                await new Promise(r => setTimeout(r, 50));
            }

            progressText.textContent = `Termine: ${success} supprime(s), ${errors} erreur(s)`;

            // Remove deleted devices from list
            deleteDevices = deleteDevices.filter(d => !deleteSelection.has(d.devEui) || errors > 0);
            deleteSelection.clear();
            renderDeleteList();
        }

        // ==================== TAG UPDATE (Phase 6) ====================
        let tagUpdateData = [];
        let tagUpdateHeaders = [];

        // Setup drag and drop for tag update
        (function initTagUpdateDropZone() {
            const dz = document.getElementById('tagUpdateDropZone');
            const fi = document.getElementById('tagUpdateFileInput');
            if (!dz || !fi) return;

            dz.addEventListener('click', () => fi.click());
            dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.style.borderColor = 'var(--accent)'; });
            dz.addEventListener('dragleave', () => { dz.style.borderColor = ''; });
            dz.addEventListener('drop', (e) => {
                e.preventDefault();
                dz.style.borderColor = '';
                if (e.dataTransfer.files.length) handleTagUpdateFile(e.dataTransfer.files[0]);
            });
            fi.addEventListener('change', (e) => {
                if (e.target.files.length) handleTagUpdateFile(e.target.files[0]);
            });
        })();

        function handleTagUpdateFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['csv', 'xls', 'xlsx'].includes(ext)) {
                alert('Format non supporte. Utilisez CSV, XLS ou XLSX.');
                return;
            }

            document.getElementById('tagUpdateFileName').textContent = file.name;

            if (ext === 'csv') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const sep = detectSeparator(e.target.result);
                    const lines = e.target.result.split('\n').filter(l => l.trim());
                    if (lines.length < 2) { alert('Fichier vide ou incomplet'); return; }
                    tagUpdateHeaders = parseCSVLine(lines[0], sep);
                    tagUpdateData = lines.slice(1).map(line => {
                        const values = parseCSVLine(line, sep);
                        const row = {};
                        tagUpdateHeaders.forEach((h, i) => { row[h] = (values[i] || '').trim(); });
                        return row;
                    }).filter(r => Object.values(r).some(v => v));
                    renderTagUpdatePreview();
                };
                reader.readAsText(file);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                        if (json.length < 2) { alert('Fichier vide ou incomplet'); return; }
                        tagUpdateHeaders = json[0].map(h => String(h).trim());
                        tagUpdateData = json.slice(1).map(row => {
                            const obj = {};
                            tagUpdateHeaders.forEach((h, i) => { obj[h] = row[i] !== undefined ? String(row[i]).trim() : ''; });
                            return obj;
                        }).filter(r => Object.values(r).some(v => v));
                        renderTagUpdatePreview();
                    } catch (err) {
                        alert('Erreur de lecture: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function renderTagUpdatePreview() {
            // Find dev_eui column
            const devEuiCol = tagUpdateHeaders.find(h => h.toLowerCase().replace(/[_\s-]/g, '') === 'deveui' || h.toLowerCase() === 'dev_eui');
            if (!devEuiCol) {
                alert('Colonne dev_eui introuvable dans le fichier');
                return;
            }

            const tagCols = tagUpdateHeaders.filter(h => h !== devEuiCol);
            document.getElementById('tagUpdateCount').textContent = tagUpdateData.length;
            document.getElementById('tagUpdateCols').textContent = tagCols.join(', ') || 'aucune';

            const thead = document.querySelector('#tagUpdatePreviewTable thead');
            const tbody = document.querySelector('#tagUpdatePreviewTable tbody');
            thead.innerHTML = `<tr>${[devEuiCol, ...tagCols].map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr>`;

            const preview = tagUpdateData.slice(0, 5);
            tbody.innerHTML = preview.map(row => {
                return `<tr>${[devEuiCol, ...tagCols].map(h => `<td>${escapeHtml(row[h] || '-')}</td>`).join('')}</tr>`;
            }).join('');

            document.getElementById('tagUpdatePreviewCard').classList.remove('hidden');
        }

        async function startTagUpdate() {
            const devEuiCol = tagUpdateHeaders.find(h => h.toLowerCase().replace(/[_\s-]/g, '') === 'deveui' || h.toLowerCase() === 'dev_eui');
            if (!devEuiCol) { alert('Colonne dev_eui introuvable'); return; }

            const tagCols = tagUpdateHeaders.filter(h => h !== devEuiCol);
            const mode = document.querySelector('input[name="tagUpdateMode"]:checked').value;

            const resultsCard = document.getElementById('tagUpdateResultsCard');
            const logContainer = document.getElementById('tagUpdateLogContainer');
            const progressDiv = document.getElementById('tagUpdateProgress');
            const progressBar = document.getElementById('tagUpdateProgressBar');
            const progressText = document.getElementById('tagUpdateProgressText');

            resultsCard.classList.remove('hidden');
            progressDiv.classList.remove('hidden');
            logContainer.innerHTML = '';

            let success = 0;
            let errors = 0;

            for (let i = 0; i < tagUpdateData.length; i++) {
                const row = tagUpdateData[i];
                const devEui = row[devEuiCol];
                if (!devEui) { errors++; continue; }

                try {
                    // GET current device
                    const deviceData = await apiCall(`/api/devices/${devEui}`);
                    const device = deviceData.device;

                    // Build new tags
                    const csvTags = {};
                    tagCols.forEach(col => {
                        if (row[col] !== undefined && row[col] !== '') {
                            csvTags[col] = row[col];
                        }
                    });

                    if (mode === 'merge') {
                        device.tags = { ...(device.tags || {}), ...csvTags };
                    } else {
                        device.tags = csvTags;
                    }

                    // PUT updated device
                    await apiCall(`/api/devices/${devEui}`, 'PUT', { device: device });

                    const entry = document.createElement('div');
                    entry.className = 'log-entry log-success';
                    entry.textContent = `âœ“ ${device.name || devEui}: tags mis a jour`;
                    logContainer.appendChild(entry);
                    success++;
                } catch (err) {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry log-error';
                    entry.textContent = `âœ— ${devEui}: ${err.message}`;
                    logContainer.appendChild(entry);
                    errors++;
                }

                const pct = Math.round(((i + 1) / tagUpdateData.length) * 100);
                progressBar.style.width = pct + '%';
                progressText.textContent = `Mise a jour: ${i + 1}/${tagUpdateData.length}`;
                logContainer.scrollTop = logContainer.scrollHeight;

                await new Promise(r => setTimeout(r, 50));
            }

            progressText.textContent = `Termine: ${success} mis a jour, ${errors} erreur(s)`;
        }

        // Load profiles on page load
        loadProfiles();
    </script>

    <!-- Gus Signature Footer -->
    <footer class="gus-footer">
        <div class="gus-signature"><span class="gus-prompt">root@gus:~$</span> cat signature.txt<span class="gus-cursor">â–ˆ</span>
<span class="gus-ascii">  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
 â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•</span>
<span class="gus-line">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</span>
<span class="gus-line">â•‘</span>    <span class="gus-title">G U S  Â·  D E V</span>       <span class="gus-line">â•‘</span>
<span class="gus-line">â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£</span>
<span class="gus-line">â•‘</span> <span class="gus-bullet">â–¸</span> Niagara / GTB / LoRaWAN <span class="gus-line">â•‘</span>
<span class="gus-line">â•‘</span> <span class="gus-bullet">â–¸</span> Device API Integration  <span class="gus-line">â•‘</span>
<span class="gus-line">â•‘</span> <span class="gus-bullet">â–¸</span> Custom Payload Decode   <span class="gus-line">â•‘</span>
<span class="gus-line">â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£</span>
<span class="gus-line">â•‘</span>    (c) Crafted by Gus     <span class="gus-line">â•‘</span>
<span class="gus-line">â•‘</span> <span class="gus-warning">âš </span> Me payer un cafÃ© svp ! <span class="gus-line">â•‘</span>
<span class="gus-line">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></div>
    </footer>
</body>
</html>